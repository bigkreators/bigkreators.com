{% extends "base.html" %}

{% block title %}Create Article - Kryptopedia{% endblock %}

{% set active_page = 'contribute' %}

{% block extra_css %}
<!-- Include a WYSIWYG editor -->
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
<style>
    .login-required-message {
        text-align: center;
        padding: 30px;
        background-color: #f8f9fa;
        border-radius: 6px;
        margin: 20px 0;
    }
    
    .login-required-message p {
        margin-bottom: 20px;
        font-size: 1.1em;
    }
</style>
{% endblock %}

{% block sidebar_extra %}
<h3>Article Guidelines</h3>
<ul>
    <li><a href="/help/formatting">Formatting Guide</a></li>
    <li><a href="/help/references">Adding References</a></li>
    <li><a href="/help/media">Adding Media</a></li>
    <li><a href="/help/categories">Using Categories</a></li>
</ul>
{% endblock %}

{% block content %}
<h1>Create a New Article</h1>

<div id="login-message" class="login-required-message" style="display: none;">
    <p>You need to be logged in to create articles.</p>
    <button id="login-to-create" class="primary-button">Login</button>
</div>

<div id="create-article-form">
    <div class="form-group">
        <label for="article-title">Title:</label>
        <input type="text" id="article-title" name="title" required>
    </div>
    
    <div class="form-group">
        <label for="article-summary">Summary:</label>
        <textarea id="article-summary" name="summary" rows="3" required></textarea>
    </div>
    
    <div class="form-group">
        <label for="article-content">Content:</label>
        <textarea id="article-content" name="content" required></textarea>
    </div>
    
    <div class="form-group">
        <label for="article-categories">Categories (comma-separated):</label>
        <input type="text" id="article-categories" name="categories">
    </div>
    
    <div class="form-group">
        <label for="article-tags">Tags (comma-separated):</label>
        <input type="text" id="article-tags" name="tags">
    </div>
    
    <div class="form-group metadata-checkboxes">
        <label>Article Contains:</label>
        <div>
            <input type="checkbox" id="has-audio" name="hasAudio">
            <label for="has-audio">Audio</label>
        </div>
        <div>
            <input type="checkbox" id="has-special-symbols" name="hasSpecialSymbols">
            <label for="has-special-symbols">Special Symbols</label>
        </div>
        <div>
            <input type="checkbox" id="contains-made-up-content" name="containsMadeUpContent">
            <label for="contains-made-up-content">Made-up Content</label>
        </div>
    </div>
    
    <button type="button" id="save-article" class="primary-button">Create Article</button>
</div>
{% endblock %}

{% block modals %}
<!-- Login Modal -->
<div id="login-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Login to Kryptopedia</h2>
        <form id="login-form">
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required>
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" required>
            </div>
            <button type="submit">Login</button>
        </form>
        <p>Don't have an account? <a href="#" id="register-link">Register</a></p>
    </div>
</div>

<!-- Register Modal -->
<div id="register-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Register for Kryptopedia</h2>
        <form id="register-form">
            <div class="form-group">
                <label for="reg-username">Username:</label>
                <input type="text" id="reg-username" name="username" required>
            </div>
            <div class="form-group">
                <label for="reg-email">Email:</label>
                <input type="email" id="reg-email" name="email" required>
            </div>
            <div class="form-group">
                <label for="reg-password">Password:</label>
                <input type="password" id="reg-password" name="password" required>
            </div>
            <div class="form-group">
                <label for="reg-confirm-password">Confirm Password:</label>
                <input type="password" id="reg-confirm-password" name="confirm-password" required>
            </div>
            <button type="submit">Register</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- jQuery and Summernote -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
<script>
    $(document).ready(function() {
        // First, check if user is logged in
        const token = localStorage.getItem('token');
        if (!token) {
            // Show a message that login is required
            $('#create-article-form').hide();
            $('#login-message').show();
            
            $('#login-to-create').click(function() {
                // Open login modal
                $('#login-modal').css('display', 'block');
                
                // When login is successful, reload the page
                $('#login-form').off('submit').on('submit', function(e) {
                    e.preventDefault();
                    login(function() {
                        window.location.reload();
                    });
                });
            });
            
            return;
        }

        // Initialize Summernote editor
        $('#article-content').summernote({
            placeholder: 'Write your article content here...',
            tabsize: 2,
            height: 400,
            toolbar: [
                ['style', ['style']],
                ['font', ['bold', 'underline', 'clear']],
                ['color', ['color']],
                ['para', ['ul', 'ol', 'paragraph']],
                ['table', ['table']],
                ['insert', ['link', 'picture']],
                ['view', ['fullscreen', 'codeview', 'help']]
            ]
        });
        
        // Handle article creation
        $('#save-article').click(function() {
            // Get form values
            const title = $('#article-title').val();
            const summary = $('#article-summary').val();
            const content = $('#article-content').summernote('code');
            const categories = $('#article-categories').val().split(',').map(item => item.trim()).filter(item => item !== '');
            const tags = $('#article-tags').val().split(',').map(item => item.trim()).filter(item => item !== '');
            
            // Get metadata
            const metadata = {
                hasAudio: $('#has-audio').is(':checked'),
                hasSpecialSymbols: $('#has-special-symbols').is(':checked'),
                containsMadeUpContent: $('#contains-made-up-content').is(':checked')
            };
            
            // Validate form
            if (!title || !summary || !content) {
                alert('Please fill in all required fields.');
                return;
            }
            
            // Create article data object
            const articleData = {
                title,
                summary,
                content,
                categories,
                tags,
                metadata
            };
            
            // Check token again before submitting
            const currentToken = localStorage.getItem('token');
            if (!currentToken) {
                alert('Your session has expired. Please login again.');
                $('#login-modal').css('display', 'block');
                return;
            }
            
            // Show loading indicator
            $('#save-article').text('Creating...').prop('disabled', true);
            
            // Send API request
            fetch('/api/articles', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentToken}`
                },
                body: JSON.stringify(articleData)
            })
            .then(response => {
                if (response.status === 401) {
                    // Token is invalid or expired
                    localStorage.removeItem('token');
                    alert('Your session has expired. Please login again.');
                    $('#login-modal').css('display', 'block');
                    throw new Error('Unauthorized');
                }
                if (!response.ok) {
                    throw new Error('Failed to create article');
                }
                return response.json();
            })
            .then(data => {
                // Redirect to the new article
                window.location.href = `/articles/${data.slug}`;
            })
            .catch(error => {
                // Reset button
                $('#save-article').text('Create Article').prop('disabled', false);
                
                if (error.message !== 'Unauthorized') {
                    console.error('Error creating article:', error);
                    alert('Failed to create article. Please try again.');
                }
            });
        });
        
        // Close buttons for modals
        $('.close').click(function() {
            $(this).closest('.modal').css('display', 'none');
        });
        
        // Close modal when clicking outside
        $(window).click(function(event) {
            if ($(event.target).hasClass('modal')) {
                $('.modal').css('display', 'none');
            }
        });
        
        // Register link in login modal
        $('#register-link').click(function(e) {
            e.preventDefault();
            $('#login-modal').css('display', 'none');
            $('#register-modal').css('display', 'block');
        });
        
        // Handle register form submission
        $('#register-form').submit(function(e) {
            e.preventDefault();
            
            const username = $('#reg-username').val();
            const email = $('#reg-email').val();
            const password = $('#reg-password').val();
            const confirmPassword = $('#reg-confirm-password').val();
            
            if (password !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }
            
            const userData = {
                username: username,
                email: email,
                password: password
            };
            
            fetch('/api/auth/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Registration failed');
                }
                return response.json();
            })
            .then(data => {
                $('#register-modal').css('display', 'none');
                alert('Registration successful! Please log in.');
                $('#login-modal').css('display', 'block');
            })
            .catch(error => {
                console.error('Error registering:', error);
                alert('Registration failed. Please try again with a different username or email.');
            });
        });
    });

    // Helper function for login
    function login(callback) {
        const email = $('#email').val();
        const password = $('#password').val();
        
        // Create form data
        const formData = new FormData();
        formData.append('username', email);
        formData.append('password', password);
        
        fetch('/api/auth/login', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Login failed');
            }
            return response.json();
        })
        .then(data => {
            // Store token
            localStorage.setItem('token', data.access_token);
            
            // Close modal
            $('#login-modal').css('display', 'none');
            
            // Call the callback function if provided
            if (typeof callback === 'function') {
                callback();
            } else {
                // Reload page if no callback
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error logging in:', error);
            alert('Login failed. Please check your credentials and try again.');
        });
    }
</script>
{% endblock %}
