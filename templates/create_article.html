```html
{% extends "base.html" %}

{% block title %}Create Article - Kryptopedia{% endblock %}

{% set active_page = 'contribute' %}

{% block extra_css %}
<!-- Include a WYSIWYG editor -->
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
<style>
    .login-required-message {
        text-align: center;
        padding: 30px;
        background-color: #f8f9fa;
        border-radius: 6px;
        margin: 20px 0;
    }
    
    .login-required-message p {
        margin-bottom: 20px;
        font-size: 1.1em;
    }

    /* Added styles for status messages */
    .status-message {
        padding: 10px 15px;
        border-radius: 4px;
        margin: 15px 0;
        display: none;
    }
    
    .error-message {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    
    .success-message {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
</style>
{% endblock %}

{% block sidebar_extra %}
<h3>Article Guidelines</h3>
<ul>
    <li><a href="/help/formatting">Formatting Guide</a></li>
    <li><a href="/help/references">Adding References</a></li>
    <li><a href="/help/media">Adding Media</a></li>
    <li><a href="/help/categories">Using Categories</a></li>
</ul>
{% endblock %}

{% block content %}
<h1>Create a New Article</h1>

<div id="login-message" class="login-required-message" style="display: none;">
    <p>You need to be logged in to create articles.</p>
    <button id="login-to-create" class="primary-button">Login</button>
</div>

<!-- Status messages -->
<div id="error-message" class="status-message error-message"></div>
<div id="success-message" class="status-message success-message"></div>

<form id="create-article-form">
    <div class="form-group">
        <label for="article-title">Title:</label>
        <input type="text" id="article-title" name="title" required>
    </div>
    
    <div class="form-group">
        <label for="article-summary">Summary:</label>
        <textarea id="article-summary" name="summary" rows="3" required></textarea>
    </div>
    
    <div class="form-group">
        <label for="article-content">Content:</label>
        <textarea id="article-content" name="content" required></textarea>
    </div>
    
    <div class="form-group">
        <label for="article-categories">Categories (comma-separated):</label>
        <input type="text" id="article-categories" name="categories">
    </div>
    
    <div class="form-group">
        <label for="article-tags">Tags (comma-separated):</label>
        <input type="text" id="article-tags" name="tags">
    </div>
    
    <div class="form-group metadata-checkboxes">
        <label>Article Contains:</label>
        <div>
            <input type="checkbox" id="has-audio" name="hasAudio">
            <label for="has-audio">Audio</label>
        </div>
        <div>
            <input type="checkbox" id="has-special-symbols" name="hasSpecialSymbols">
            <label for="has-special-symbols">Special Symbols</label>
        </div>
        <div>
            <input type="checkbox" id="contains-made-up-content" name="containsMadeUpContent">
            <label for="contains-made-up-content">Made-up Content</label>
        </div>
    </div>
    
    <button type="submit" id="save-article" class="primary-button">Create Article</button>
</form>
{% endblock %}

{% block modals %}
<!-- Login Modal -->
<div id="login-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Login to Kryptopedia</h2>
        <form id="login-form">
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required>
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" required>
            </div>
            <button type="submit">Login</button>
        </form>
        <p>Don't have an account? <a href="#" id="register-link">Register</a></p>
    </div>
</div>

<!-- Register Modal -->
<div id="register-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Register for Kryptopedia</h2>
        <form id="register-form">
            <div class="form-group">
                <label for="reg-username">Username:</label>
                <input type="text" id="reg-username" name="username" required>
            </div>
            <div class="form-group">
                <label for="reg-email">Email:</label>
                <input type="email" id="reg-email" name="email" required>
            </div>
            <div class="form-group">
                <label for="reg-password">Password:</label>
                <input type="password" id="reg-password" name="password" required>
            </div>
            <div class="form-group">
                <label for="reg-confirm-password">Confirm Password:</label>
                <input type="password" id="reg-confirm-password" name="confirm-password" required>
            </div>
            <button type="submit">Register</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- jQuery and Summernote -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
<script>
    $(document).ready(function() {
        // Check if user is logged in
        const token = localStorage.getItem('token');
        if (!token) {
            // Show a message that login is required
            $('#create-article-form').hide();
            $('#login-message').show();
            
            $('#login-to-create').click(function() {
                // Open login modal
                $('#login-modal').css('display', 'block');
            });
            
            return;
        }

        // Initialize Summernote editor
        $('#article-content').summernote({
            placeholder: 'Write your article content here...',
            tabsize: 2,
            height: 400,
            toolbar: [
                ['style', ['style']],
                ['font', ['bold', 'underline', 'clear']],
                ['color', ['color']],
                ['para', ['ul', 'ol', 'paragraph']],
                ['table', ['table']],
                ['insert', ['link', 'picture']],
                ['view', ['fullscreen', 'codeview', 'help']]
            ]
        });
        
        // Show error message function
        function showError(message) {
            $('#error-message').text(message).show();
            setTimeout(function() {
                $('#error-message').fadeOut();
            }, 5000);
        }
        
        // Show success message function
        function showSuccess(message) {
            $('#success-message').text(message).show();
        }
        
        // Handle article creation
        $('#create-article-form').submit(function(e) {
            e.preventDefault();
            
            // Get form values
            const title = $('#article-title').val();
            const summary = $('#article-summary').val();
            const content = $('#article-content').summernote('code');
            const categories = $('#article-categories').val().split(',').map(item => item.trim()).filter(item => item !== '');
            const tags = $('#article-tags').val().split(',').map(item => item.trim()).filter(item => item !== '');
            
            // Get metadata
            const metadata = {
                hasAudio: $('#has-audio').is(':checked'),
                hasSpecialSymbols: $('#has-special-symbols').is(':checked'),
                containsMadeUpContent: $('#contains-made-up-content').is(':checked')
            };
            
            // Validate form
            if (!title) {
                showError('Please enter a title for the article.');
                return;
            }
            
            if (!summary) {
                showError('Please provide a summary for the article.');
                return;
            }
            
            if (!content || content === '<p><br></p>') {
                showError('Please enter content for the article.');
                return;
            }
            
            // Create article data object
            const articleData = {
                title,
                summary,
                content,
                categories,
                tags,
                metadata
            };
            
            // Check token again before submitting
            const currentToken = localStorage.getItem('token');
            if (!currentToken) {
                showError('Your session has expired. Please login again.');
                $('#login-modal').css('display', 'block');
                return;
            }
            
            // Show loading indicator
            $('#save-article').text('Creating...').prop('disabled', true);
            
            // Send API request
            fetch('/api/articles', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentToken}`
                },
                body: JSON.stringify(articleData)
            })
            .then(response => {
                if (response.status === 401) {
                    // Token is invalid or expired
                    localStorage.removeItem('token');
                    showError('Your session has expired. Please login again.');
                    $('#login-modal').css('display', 'block');
                    throw new Error('Unauthorized');
                }
                
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.detail || 'Failed to create article');
                    });
                }
                
                return response.json();
            })
            .then(data => {
                showSuccess('Article created successfully!');
                
                // Redirect to the new article after a brief delay
                setTimeout(function() {
                    window.location.href = `/articles/${data.slug}`;
                }, 1000);
            })
            .catch(error => {
                // Reset button
                $('#save-article').text('Create Article').prop('disabled', false);
                
                if (error.message !== 'Unauthorized') {
                    console.error('Error creating article:', error);
                    showError(error.message || 'Failed to create article. Please try again.');
                }
            });
        });
        
        // Modal functions
        $('.close').click(function() {
            $(this).closest('.modal').css('display', 'none');
        });
        
        $(window).click(function(event) {
            if ($(event.target).hasClass('modal')) {
                $('.modal').css('display', 'none');
            }
        });
        
        $('#register-link').click(function(e) {
            e.preventDefault();
            $('#login-modal').css('display', 'none');
            $('#register-modal').css('display', 'block');
        });
        
        // Handle login form submission
        $('#login-form').submit(function(e) {
            e.preventDefault();
            
            const email = $('#email').val();
            const password = $('#password').val();
            
            // Create form data for OAuth2 format
            const formData = new URLSearchParams();
            formData.append('username', email); // API expects username field
            formData.append('password', password);
            
            fetch('/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Login failed');
                }
                return response.json();
            })
            .then(data => {
                // Store token
                localStorage.setItem('token', data.access_token);
                
                // Close modal
                $('#login-modal').css('display', 'none');
                
                // Reload page
                window.location.reload();
            })
            .catch(error => {
                console.error('Error logging in:', error);
                showError('Login failed. Please check your credentials and try again.');
            });
        });
        
        // Handle register form submission
        $('#register-form').submit(function(e) {
            e.preventDefault();
            
            const username = $('#reg-username').val();
            const email = $('#reg-email').val();
            const password = $('#reg-password').val();
            const confirmPassword = $('#reg-confirm-password').val();
            
            if (password !== confirmPassword) {
                showError('Passwords do not match!');
                return;
            }
            
            const userData = {
                username: username,
                email: email,
                password: password
            };
            
            fetch('/api/auth/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.detail || 'Registration failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                $('#register-modal').css('display', 'none');
                showSuccess('Registration successful! Please log in.');
                $('#login-modal').css('display', 'block');
            })
            .catch(error => {
                console.error('Error registering:', error);
                showError(error.message || 'Registration failed. Please try again with a different username or email.');
            });
        });
    });
</script>
{% endblock %}
```
