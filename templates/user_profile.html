<!-- File: templates/user_profile.html -->
{% extends "base.html" %}

{% block title %}{% if user %}{{ user.username }}'s Profile{% else %}User Profile{% endif %} - Kryptopedia{% endblock %}

{% set active_page = 'profile' %}

{% block extra_css %}
<style>
    .profile-container {
        max-width: 1000px;
        margin: 0 auto;
    }
    
    .profile-header {
        background-color: #f8f9fa;
        padding: 30px;
        border-radius: 8px;
        margin-bottom: 30px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 30px;
    }
    
    .profile-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background-color: #0645ad;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        font-weight: bold;
    }
    
    .profile-info {
        flex: 1;
    }
    
    .profile-name {
        font-size: 28px;
        margin-bottom: 5px;
    }
    
    .profile-role {
        font-size: 16px;
        color: #666;
        margin-bottom: 10px;
    }
    
    .profile-bio {
        color: #555;
        line-height: 1.6;
    }
    
    .profile-stats {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 15px;
    }
    
    .stat-item {
        text-align: center;
        min-width: 80px;
    }
    
    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #0645ad;
    }
    
    .stat-label {
        font-size: 14px;
        color: #666;
    }
    
    .profile-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 20px;
    }
    
    .profile-action-button {
        padding: 8px 16px;
        background-color: #0645ad;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        font-size: 14px;
    }
    
    .profile-action-button:hover {
        background-color: #053a7a;
    }
    
    .profile-tabs {
        margin-bottom: 20px;
        border-bottom: 1px solid #ddd;
    }
    
    .profile-tabs ul {
        display: flex;
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .profile-tabs li {
        margin-right: 10px;
    }
    
    .profile-tabs a {
        display: block;
        padding: 10px 15px;
        text-decoration: none;
        color: #555;
        border-bottom: 3px solid transparent;
    }
    
    .profile-tabs a:hover {
        color: #0645ad;
    }
    
    .profile-tabs a.active {
        color: #0645ad;
        border-bottom-color: #0645ad;
    }
    
    .profile-tab-content {
        display: none;
        padding: 20px 0;
    }
    
    .profile-tab-content.active {
        display: block;
    }
    
    .login-required {
        text-align: center;
        padding: 50px 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
        margin: 20px 0;
        display: none;
    }
    
    .login-required p {
        margin-bottom: 20px;
        font-size: 18px;
        color: #555;
    }
    
    .login-required button {
        padding: 10px 20px;
        background-color: #0645ad;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
    }
    
    .articles-list, .contributions-list, .proposals-list, .rewards-list {
        margin-bottom: 30px;
    }
    
    .list-item {
        padding: 15px;
        border-bottom: 1px solid #eee;
    }
    
    .list-item:last-child {
        border-bottom: none;
    }
    
    .list-item-title {
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .list-item-date {
        font-size: 14px;
        color: #666;
    }
    
    .list-item-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 5px;
    }
    
    .badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 12px;
        margin-right: 5px;
    }
    
    .badge-approved {
        background-color: #d4edda;
        color: #155724;
    }
    
    .badge-pending {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .badge-rejected {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }
    
    .page-link {
        display: inline-block;
        padding: 5px 10px;
        margin: 0 5px;
        background: #f5f5f5;
        color: #333;
        text-decoration: none;
        border-radius: 4px;
    }
    
    .page-link:hover {
        background: #e0e0e0;
    }
    
    .page-info {
        padding: 5px;
        color: #666;
    }
    
    .error-message, .success-message {
        padding: 10px 15px;
        margin: 15px 0;
        border-radius: 4px;
        display: none;
    }
    
    .error-message {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    
    .success-message {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    
    @media (max-width: 768px) {
        .profile-header {
            flex-direction: column;
            text-align: center;
            gap: 15px;
        }
        
        .profile-avatar {
            margin: 0 auto;
        }
        
        .profile-stats {
            justify-content: center;
        }
        
        .profile-actions {
            justify-content: center;
        }
        
        .profile-tabs ul {
            flex-wrap: wrap;
        }
    }
</style>
{% endblock %}

{% block sidebar_extra %}
<h3>Profile</h3>
<ul>
    <li><a href="/profile" {% if active_tab == 'overview' %}class="active"{% endif %}>Overview</a></li>
    {% if is_own_profile %}
    <li><a href="/profile/edit" {% if active_tab == 'edit' %}class="active"{% endif %}>Edit Profile</a></li>
    {% endif %}
</ul>

<h3>Actions</h3>
<ul>
    <li><a href="/create-article">Create Article</a></li>
    <li><a href="/proposals">View Proposals</a></li>
    <li><a href="/special/recentchanges">Recent Changes</a></li>
    {% if user and user.role in ['admin', 'editor'] %}
    <li><a href="/admin">Admin Dashboard</a></li>
    {% endif %}
</ul>
{% endblock %}

{% block content %}
<div class="profile-container">
    <!-- Status messages container -->
    <div id="error-message" class="error-message"></div>
    <div id="success-message" class="success-message"></div>
    
    <!-- Login required message -->
    <div id="login-required" class="login-required">
        <p>You need to be logged in to view this profile.</p>
        <button id="login-to-view-profile" class="primary-button">Login</button>
    </div>
    
    <!-- Main profile content -->
    <div id="profile-content">
        {% if user %}
        <div class="profile-header">
            <div class="profile-avatar user-avatar">
                {{ user.username[0]|upper }}
            </div>
            
            <div class="profile-info">
                <h1 class="profile-name user-display-name">
                    {{ user.displayName or user.username }}
                </h1>
                <div class="profile-role user-role">{{ user.role|title }}</div>
                <div class="profile-bio user-bio">{{ user.bio or "No bio provided" }}</div>
                
                <div class="profile-stats">
                    <div class="stat-item">
                        <div class="stat-value articles-count">{{ user.contributions.articlesCreated|default(0) }}</div>
                        <div class="stat-label">Articles</div>
                    </div>
                    
                    <div class="stat-item">
                        <div class="stat-value edits-count">{{ user.contributions.editsPerformed|default(0) }}</div>
                        <div class="stat-label">Edits</div>
                    </div>
                    
                    <div class="stat-item">
                        <div class="stat-value">{{ user.reputation|default(0) }}</div>
                        <div class="stat-label">Reputation</div>
                    </div>
                    
                    <div class="stat-item">
                        <div class="stat-value rewards-count">{{ user.contributions.rewardsReceived|default(0) }}</div>
                        <div class="stat-label">Rewards</div>
                    </div>
                </div>
                
                <div class="profile-actions">
                    {% if is_own_profile %}
                    <a href="/profile/edit" class="profile-action-button">Edit Profile</a>
                    {% endif %}
                    
                    {% if is_admin and not is_own_profile %}
                    <a href="/admin/users/{{ user._id }}/edit" class="profile-action-button">Admin Edit</a>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="profile-tabs">
            <ul>
                <li><a href="#articles" class="profile-tab-link" id="articles-tab">Articles</a></li>
                <li><a href="#contributions" class="profile-tab-link" id="contributions-tab">Contributions</a></li>
                <li><a href="#proposals" class="profile-tab-link" id="proposals-tab">Proposals</a></li>
                <li><a href="#rewards" class="profile-tab-link" id="rewards-tab">Rewards</a></li>
            </ul>
        </div>
        
        <div id="articles" class="profile-tab-content">
            <h2>Articles</h2>
            
            {% if articles %}
            <div class="articles-list">
                {% for article in articles %}
                <div class="list-item">
                    <div class="list-item-title">
                        <a href="/articles/{{ article.slug }}">{{ article.title }}</a>
                    </div>
                    <div class="list-item-info">
                        <div class="list-item-date">
                            Created: {{ article.createdAt|strftime('%Y-%m-%d') }}
                        </div>
                        <div class="list-item-views">
                            Views: {{ article.views }}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if articles_total > articles_limit %}
            <div class="pagination">
                {% if articles_skip > 0 %}
                <a href="?tab=articles&skip={{ max(0, articles_skip - articles_limit) }}" class="page-link">Previous</a>
                {% endif %}
                
                <span class="page-info">Showing {{ articles_skip + 1 }}-{{ min(articles_skip + articles_limit, articles_total) }} of {{ articles_total }}</span>
                
                {% if articles_skip + articles_limit < articles_total %}
                <a href="?tab=articles&skip={{ articles_skip + articles_limit }}" class="page-link">Next</a>
                {% endif %}
            </div>
            {% endif %}
            {% else %}
            <p>No articles found.</p>
            {% endif %}
        </div>
        
        <div id="contributions" class="profile-tab-content">
            <h2>Contributions</h2>
            
            {% if contributions %}
            <div class="contributions-list">
                {% for contribution in contributions %}
                <div class="list-item">
                    <div class="list-item-title">
                        Edited <a href="/articles/{{ contribution.articleSlug }}">{{ contribution.articleTitle }}</a>
                    </div>
                    <div class="list-item-info">
                        <div class="list-item-date">
                            {{ contribution.createdAt|strftime('%Y-%m-%d %H:%M') }}
                        </div>
                        <div class="list-item-comment">
                            {{ contribution.comment or "No comment provided" }}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if contributions_total > contributions_limit %}
            <div class="pagination">
                {% if contributions_skip > 0 %}
                <a href="?tab=contributions&contributions_skip={{ max(0, contributions_skip - contributions_limit) }}" class="page-link">Previous</a>
                {% endif %}
                
                <span class="page-info">Showing {{ contributions_skip + 1 }}-{{ min(contributions_skip + contributions_limit, contributions_total) }} of {{ contributions_total }}</span>
                
                {% if contributions_skip + contributions_limit < contributions_total %}
                <a href="?tab=contributions&contributions_skip={{ contributions_skip + contributions_limit }}" class="page-link">Next</a>
                {% endif %}
            </div>
            {% endif %}
            {% else %}
            <p>No contributions found.</p>
            {% endif %}
        </div>
        
        <div id="proposals" class="profile-tab-content">
            <h2>Edit Proposals</h2>
            
            {% if proposals %}
            <div class="proposals-list">
                {% for proposal in proposals %}
                <div class="list-item">
                    <div class="list-item-title">
                        Proposed edit to <a href="/articles/{{ proposal.articleSlug }}">{{ proposal.articleTitle }}</a>
                        
                        {% if proposal.status == 'pending' %}
                        <span class="badge badge-pending">Pending</span>
                        {% elif proposal.status == 'approved' %}
                        <span class="badge badge-approved">Approved</span>
                        {% elif proposal.status == 'rejected' %}
                        <span class="badge badge-rejected">Rejected</span>
                        {% endif %}
                    </div>
                    <div class="list-item-info">
                        <div class="list-item-date">
                            {{ proposal.proposedAt|strftime('%Y-%m-%d %H:%M') }}
                        </div>
                        <div class="list-item-summary">
                            {{ proposal.summary }}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if proposals_total > proposals_limit %}
            <div class="pagination">
                {% if proposals_skip > 0 %}
                <a href="?tab=proposals&proposals_skip={{ max(0, proposals_skip - proposals_limit) }}" class="page-link">Previous</a>
                {% endif %}
                
                <span class="page-info">Showing {{ proposals_skip + 1 }}-{{ min(proposals_skip + proposals_limit, proposals_total) }} of {{ proposals_total }}</span>
                
                {% if proposals_skip + proposals_limit < proposals_total %}
                <a href="?tab=proposals&proposals_skip={{ proposals_skip + proposals_limit }}" class="page-link">Next</a>
                {% endif %}
            </div>
            {% endif %}
            {% else %}
            <p>No proposals found.</p>
            {% endif %}
        </div>
        
        <div id="rewards" class="profile-tab-content">
            <h2>Rewards Received</h2>
            
            {% if rewards %}
            <div class="rewards-list">
                {% for reward in rewards %}
                <div class="list-item">
                    <div class="list-item-title">
                        {{ reward.rewardType|title }} reward for <a href="/articles/{{ reward.articleSlug }}">{{ reward.articleTitle }}</a>
                    </div>
                    <div class="list-item-info">
                        <div class="list-item-date">
                            {{ reward.rewardedAt|strftime('%Y-%m-%d') }}
                        </div>
                        <div class="list-item-points">
                            +{{ reward.points }} points from {{ reward.rewarderUsername }}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if rewards_total > rewards_limit %}
            <div class="pagination">
                {% if rewards_skip > 0 %}
                <a href="?tab=rewards&rewards_skip={{ max(0, rewards_skip - rewards_limit) }}" class="page-link">Previous</a>
                {% endif %}
                
                <span class="page-info">Showing {{ rewards_skip + 1 }}-{{ min(rewards_skip + rewards_limit, rewards_total) }} of {{ rewards_total }}</span>
                
                {% if rewards_skip + rewards_limit < rewards_total %}
                <a href="?tab=rewards&rewards_skip={{ rewards_skip + rewards_limit }}" class="page-link">Next</a>
                {% endif %}
            </div>
            {% endif %}
            {% else %}
            <p>No rewards found.</p>
            {% endif %}
        </div>
        {% else %}
        <div class="error-message">User not found.</div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/profile.js"></script>
{% endblock %}
