<!-- File: templates/user_management.html -->
{% extends "base.html" %}

{% block title %}User Management - Kryptopedia{% endblock %}

{% set active_page = 'admin' %}

{% block extra_css %}
<style>
    .admin-container {
        margin: 20px 0;
    }
    
    .filter-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .filter-tab {
        padding: 8px 16px;
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        color: #333;
    }
    
    .filter-tab.active {
        background-color: #0645ad;
        color: white;
        border-color: #0645ad;
    }
    
    .role-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 12px;
        color: white;
    }
    
    .role-admin {
        background-color: #dc3545;
    }
    
    .role-editor {
        background-color: #0645ad;
    }
    
    .role-user {
        background-color: #28a745;
    }
    
    .users-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }
    
    .users-table th,
    .users-table td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: left;
    }
    
    .users-table th {
        background-color: #f5f5f5;
        font-weight: 600;
    }
    
    .user-actions {
        display: flex;
        gap: 5px;
    }
    
    .action-button {
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 12px;
        text-decoration: none;
        display: inline-block;
    }
    
    .view-button {
        background-color: #6c757d;
        color: white;
    }
    
    .edit-button {
        background-color: #0645ad;
        color: white;
    }
    
    .promote-button {
        background-color: #28a745;
        color: white;
    }
    
    .demote-button {
        background-color: #ffc107;
        color: #212529;
    }
    
    .reset-button {
        background-color: #6c757d;
        color: white;
    }
    
    .block-button, .unblock-button {
        background-color: #dc3545;
        color: white;
    }
    
    .no-users {
        padding: 30px;
        text-align: center;
        background-color: #f8f9fa;
        border-radius: 8px;
    }
    
    .status-message {
        padding: 10px 15px;
        border-radius: 4px;
        margin: 15px 0;
        display: none;
    }
    
    .error-message {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    
    .success-message {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    
    .search-bar {
        margin-bottom: 20px;
    }
    
    .search-bar input {
        padding: 8px 12px;
        width: 300px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .search-bar button {
        padding: 8px 12px;
        background-color: #0645ad;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.6);
    }
    
    .modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 25px;
        border-radius: 8px;
        max-width: 500px;
        position: relative;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .close {
        position: absolute;
        right: 15px;
        top: 10px;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        color: #666;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
    }
    
    .form-group select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .form-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }
    
    .primary-button {
        padding: 8px 16px;
        background-color: #0645ad;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .primary-button:hover {
        background-color: #053a7a;
    }
    
    .cancel-button {
        padding: 8px 16px;
        background-color: #f5f5f5;
        color: #333;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .cancel-button:hover {
        background-color: #e8e8e8;
    }
    
    /* Password reset modal */
    .warning-box {
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        color: #856404;
        padding: 10px 15px;
        border-radius: 4px;
        margin: 15px 0;
    }
</style>
{% endblock %}

{% block sidebar_extra %}
<h3>Administration</h3>
<ul>
    <li><a href="/admin/articles">Article Management</a></li>
    <li><a href="/admin/users" class="active">User Management</a></li>
    <li><a href="/admin/proposals">Edit Proposals</a></li>
    <li><a href="/special/statistics">Wiki Statistics</a></li>
</ul>
{% endblock %}

{% block content %}
<h1>User Management</h1>

<div class="status-message error-message" id="error-message"></div>
<div class="status-message success-message" id="success-message"></div>

<div class="admin-container">
    <div class="filter-tabs">
        <a href="/admin/users" class="filter-tab {% if not role %}active{% endif %}">All Users</a>
        <a href="/admin/users?role=admin" class="filter-tab {% if role == 'admin' %}active{% endif %}">Administrators</a>
        <a href="/admin/users?role=editor" class="filter-tab {% if role == 'editor' %}active{% endif %}">Editors</a>
        <a href="/admin/users?role=user" class="filter-tab {% if role == 'user' %}active{% endif %}">Regular Users</a>
    </div>
    
    <div class="search-bar">
        <form action="/admin/users" method="get">
            <input type="text" name="search" placeholder="Search users..." value="{{ search or '' }}">
            {% if role %}
            <input type="hidden" name="role" value="{{ role }}">
            {% endif %}
            <button type="submit">Search</button>
        </form>
    </div>
    
    {% if users %}
        <table class="users-table">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Join Date</th>
                    <th>Last Login</th>
                    <th>Contributions</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr id="user-row-{{ user._id }}">
                    <td>
                        <a href="/profile/{{ user.username }}">{{ user.username }}</a>
                    </td>
                    <td>{{ user.email }}</td>
                    <td>
                        <span class="role-badge role-{{ user.role }}">{{ user.role|title }}</span>
                    </td>
                    <td>{{ user.joinDate|strftime('%Y-%m-%d') }}</td>
                    <td>{{ user.lastLogin|strftime('%Y-%m-%d') or 'Never' }}</td>
                    <td>
                        <span title="Articles Created">üìù {{ user.contributions.articlesCreated }}</span> | 
                        <span title="Edits Performed">‚úèÔ∏è {{ user.contributions.editsPerformed }}</span> | 
                        <span title="Reputation">‚≠ê {{ user.reputation }}</span>
                    </td>
                    <td>
                        <div class="user-actions">
                            <a href="/profile/{{ user.username }}" class="action-button view-button">View</a>
                            
                            {% if user.role != 'admin' or current_user.username == 'admin' %}
                                {% if user.role == 'user' %}
                                <button class="action-button promote-button" onclick="changeRole('{{ user._id }}', '{{ user.username }}', 'editor')">Promote to Editor</button>
                                {% elif user.role == 'editor' %}
                                <button class="action-button demote-button" onclick="changeRole('{{ user._id }}', '{{ user.username }}', 'user')">Demote to User</button>
                                {% if current_user.username == 'admin' %}
                                <button class="action-button promote-button" onclick="changeRole('{{ user._id }}', '{{ user.username }}', 'admin')">Promote to Admin</button>
                                {% endif %}
                                {% elif user.role == 'admin' and current_user.username == 'admin' and user.username != 'admin' %}
                                <button class="action-button demote-button" onclick="changeRole('{{ user._id }}', '{{ user.username }}', 'editor')">Demote to Editor</button>
                                {% endif %}
                            {% endif %}
                            
                            {% if user.username != 'admin' and user.username != current_user.username %}
                            <button class="action-button reset-button" onclick="showResetPasswordModal('{{ user._id }}', '{{ user.username }}')">Reset Password</button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <!-- Pagination -->
        {% if total > limit %}
        <div class="pagination">
            {% if skip > 0 %}
            <a href="?{% if role %}role={{ role }}&{% endif %}{% if search %}search={{ search }}&{% endif %}skip={{ max(0, skip - limit) }}&limit={{ limit }}" class="page-link">Previous</a>
            {% endif %}
            
            <span class="page-info">Showing {{ skip + 1 }}-{{ min(skip + limit, total) }} of {{ total }}</span>
            
            {% if skip + limit < total %}
            <a href="?{% if role %}role={{ role }}&{% endif %}{% if search %}search={{ search }}&{% endif %}skip={{ skip + limit }}&limit={{ limit }}" class="page-link">Next</a>
            {% endif %}
        </div>
        {% endif %}
    {% else %}
        <div class="no-users">
            <p>No users found.</p>
            {% if search %}
                <p>Try adjusting your search query.</p>
            {% endif %}
        </div>
    {% endif %}
</div>

<!-- Change Role Modal -->
<div id="role-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="role-modal-title">Change User Role</h2>
        
        <p id="role-modal-description">You are about to change the role for user <strong id="role-username"></strong>.</p>
        
        <form id="role-form">
            <input type="hidden" id="user-id" name="userId">
            <input type="hidden" id="new-role" name="newRole">
            
            <div class="form-group">
                <label for="confirmation">Type the username to confirm:</label>
                <input type="text" id="role-confirmation" name="confirmation" placeholder="Enter username">
            </div>
            
            <div class="form-actions">
                <button type="button" id="cancel-role-button" class="cancel-button">Cancel</button>
                <button type="submit" id="confirm-role-button" class="primary-button" disabled>Change Role</button>
            </div>
        </form>
    </div>
</div>

<!-- Reset Password Modal -->
<div id="reset-password-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Reset User Password</h2>
        
        <p>You are about to reset the password for user <strong id="reset-username"></strong>.</p>
        
        <div class="warning-box">
            <p>‚ö†Ô∏è This will generate a new random password and send it to the user's email. The user will need to change it on first login.</p>
        </div>
        
        <form id="reset-password-form">
            <input type="hidden" id="reset-user-id" name="userId">
            
            <div class="form-group">
                <label for="reset-confirmation">Type the username to confirm:</label>
                <input type="text" id="reset-confirmation" name="confirmation" placeholder="Enter username">
            </div>
            
            <div class="form-actions">
                <button type="button" id="cancel-reset-button" class="cancel-button">Cancel</button>
                <button type="submit" id="confirm-reset-button" class="primary-button" disabled>Reset Password</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('token');
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');
    
    // Role change modal elements
    const roleModal = document.getElementById('role-modal');
    const roleModalTitle = document.getElementById('role-modal-title');
    const roleUsername = document.getElementById('role-username');
    const roleForm = document.getElementById('role-form');
    const userId = document.getElementById('user-id');
    const newRole = document.getElementById('new-role');
    const roleConfirmation = document.getElementById('role-confirmation');
    const confirmRoleButton = document.getElementById('confirm-role-button');
    const cancelRoleButton = document.getElementById('cancel-role-button');
    
    // Reset password modal elements
    const resetPasswordModal = document.getElementById('reset-password-modal');
    const resetUsername = document.getElementById('reset-username');
    const resetPasswordForm = document.getElementById('reset-password-form');
    const resetUserId = document.getElementById('reset-user-id');
    const resetConfirmation = document.getElementById('reset-confirmation');
    const confirmResetButton = document.getElementById('confirm-reset-button');
    const cancelResetButton = document.getElementById('cancel-reset-button');
    
    // Close button handlers
    const closeButtons = document.querySelectorAll('.close');
    closeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const modal = this.closest('.modal');
            if (modal) modal.style.display = 'none';
        });
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    });
    
    // Role change confirmation input handler
    if (roleConfirmation) {
        roleConfirmation.addEventListener('input', function() {
            confirmRoleButton.disabled = this.value !== roleUsername.textContent;
        });
    }
    
    // Reset password confirmation input handler
    if (resetConfirmation) {
        resetConfirmation.addEventListener('input', function() {
            confirmResetButton.disabled = this.value !== resetUsername.textContent;
        });
    }
    
    // Role form submission handler
    if (roleForm) {
        roleForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!token) {
                showError('You must be logged in as an administrator to perform this action');
                return;
            }
            
            if (roleConfirmation.value !== roleUsername.textContent) {
                showError('Username confirmation does not match');
                return;
            }
            
            // Show loading state
            confirmRoleButton.disabled = true;
            confirmRoleButton.textContent = 'Processing...';
            
            const data = {
                role: newRole.value
            };
            
            fetch(`/api/users/${userId.value}/role`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.detail || 'Failed to change user role');
                    });
                }
                return response.json();
            })
            .then(data => {
                showSuccess(`User role changed to ${newRole.value} successfully`);
                
                // Close modal
                roleModal.style.display = 'none';
                
                // Update UI
                const userRow = document.getElementById(`user-row-${userId.value}`);
                if (userRow) {
                    const roleCell = userRow.querySelector('td:nth-child(3)');
                    if (roleCell) {
                        roleCell.innerHTML = `<span class="role-badge role-${newRole.value}">${capitalizeFirstLetter(newRole.value)}</span>`;
                    }
                    
                    // Refresh the page after a short delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }
            })
            .catch(error => {
                console.error('Error changing user role:', error);
                showError(error.message || 'Failed to change user role');
            })
            .finally(() => {
                // Reset form
                roleForm.reset();
                confirmRoleButton.disabled = true;
                confirmRoleButton.textContent = 'Change Role';
            });
        });
    }
    
    // Reset password form submission handler
    if (resetPasswordForm) {
        resetPasswordForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!token) {
                showError('You must be logged in as an administrator to perform this action');
                return;
            }
            
            if (resetConfirmation.value !== resetUsername.textContent) {
                showError('Username confirmation does not match');
                return;
            }
            
            // Show loading state
            confirmResetButton.disabled = true;
            confirmResetButton.textContent = 'Processing...';
            
            fetch(`/api/users/${resetUserId.value}/reset-password`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.detail || 'Failed to reset password');
                    });
                }
                return response.json();
            })
            .then(data => {
                showSuccess(`Password reset successful. A new password has been sent to the user's email.`);
                
                // Close modal
                resetPasswordModal.style.display = 'none';
            })
            .catch(error => {
                console.error('Error resetting password:', error);
                showError(error.message || 'Failed to reset password');
            })
            .finally(() => {
                // Reset form
                resetPasswordForm.reset();
                confirmResetButton.disabled = true;
                confirmResetButton.textContent = 'Reset Password';
            });
        });
    }
    
    // Cancel button handlers
    if (cancelRoleButton) {
        cancelRoleButton.addEventListener('click', function() {
            roleModal.style.display = 'none';
            roleForm.reset();
        });
    }
    
    if (cancelResetButton) {
        cancelResetButton.addEventListener('click', function() {
            resetPasswordModal.style.display = 'none';
            resetPasswordForm.reset();
        });
    }
    
    // Global functions for user management
    window.changeRole = function(userId, username, role) {
        // Set modal values
        window.userId.value = userId;
        roleUsername.textContent = username;
        newRole.value = role;
        
        // Update modal title
        if (role === 'admin') {
            roleModalTitle.textContent = `Promote User to Administrator`;
        } else if (role === 'editor') {
            roleModalTitle.textContent = `Change User Role to Editor`;
        } else if (role === 'user') {
            roleModalTitle.textContent = `Demote User to Regular User`;
        }
        
        // Show modal
        roleModal.style.display = 'block';
        
        // Focus on confirmation input
        roleConfirmation.focus();
    };
    
    window.showResetPasswordModal = function(userId, username) {
        // Set modal values
        resetUserId.value = userId;
        resetUsername.textContent = username;
        
        // Show modal
        resetPasswordModal.style.display = 'block';
        
        // Focus on confirmation input
        resetConfirmation.focus();
    };
    
    // Helper functions
    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        successMessage.style.display = 'none';
        
        // Scroll to error
        errorMessage.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // Hide after 5 seconds
        setTimeout(() => {
            errorMessage.style.display = 'none';
        }, 5000);
    }
    
    function showSuccess(message) {
