<!-- File: templates/user_management.html -->
{% extends "base.html" %}

{% block title %}User Management - Kryptopedia{% endblock %}

{% set active_page = 'admin' %}

{% block extra_css %}
<style>
    .admin-container {
        margin: 20px 0;
    }
    
    .filter-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .filter-tab {
        padding: 8px 16px;
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        color: #333;
    }
    
    .filter-tab.active {
        background-color: #0645ad;
        color: white;
        border-color: #0645ad;
    }
    
    .role-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 12px;
        margin-left: 10px;
        color: white;
    }
    
    .role-admin {
        background-color: #dc3545;
    }
    
    .role-editor {
        background-color: #28a745;
    }
    
    .role-user {
        background-color: #17a2b8;
    }
    
    .users-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }
    
    .users-table th,
    .users-table td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: left;
    }
    
    .users-table th {
        background-color: #f5f5f5;
        font-weight: 600;
    }
    
    .user-actions {
        display: flex;
        gap: 5px;
    }
    
    .action-button {
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 12px;
        text-decoration: none;
        display: inline-block;
    }
    
    .view-button {
        background-color: #6c757d;
        color: white;
    }
    
    .edit-button {
        background-color: #0645ad;
        color: white;
    }
    
    .promote-button {
        background-color: #28a745;
        color: white;
    }
    
    .demote-button {
        background-color: #ffc107;
        color: #212529;
    }
    
    .delete-button {
        background-color: #dc3545;
        color: white;
    }
    
    .no-users {
        padding: 30px;
        text-align: center;
        background-color: #f8f9fa;
        border-radius: 8px;
    }
    
    .status-message {
        padding: 10px 15px;
        border-radius: 4px;
        margin: 15px 0;
        display: none;
    }
    
    .error-message {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    
    .success-message {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    
    .search-bar {
        margin-bottom: 20px;
    }
    
    .search-bar input {
        padding: 8px 12px;
        width: 300px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .search-bar button {
        padding: 8px 12px;
        background-color: #0645ad;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    
    /* Role change modal */
    .role-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.6);
    }
    
    .role-modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 25px;
        border-radius: 8px;
        max-width: 500px;
        position: relative;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .role-selection {
        margin: 20px 0;
    }
    
    .role-option {
        margin: 10px 0;
    }
    
    .form-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block sidebar_extra %}
<h3>Administration</h3>
<ul>
    <li><a href="/admin">Dashboard</a></li>
    <li><a href="/admin/articles">Article Management</a></li>
    <li><a href="/admin/users" class="active">User Management</a></li>
    <li><a href="/admin/proposals">Edit Proposals</a></li>
    <li><a href="/special/statistics">Wiki Statistics</a></li>
</ul>
{% endblock %}

{% block content %}
<h1>User Management</h1>

<div class="status-message error-message" id="error-message"></div>
<div class="status-message success-message" id="success-message"></div>

<div class="admin-container">
    <div class="filter-tabs">
        <a href="/admin/users" class="filter-tab {% if not role %}active{% endif %}">All Users</a>
        <a href="/admin/users?role=admin" class="filter-tab {% if role == 'admin' %}active{% endif %}">Administrators</a>
        <a href="/admin/users?role=editor" class="filter-tab {% if role == 'editor' %}active{% endif %}">Editors</a>
        <a href="/admin/users?role=user" class="filter-tab {% if role == 'user' %}active{% endif %}">Regular Users</a>
    </div>
    
    <div class="search-bar">
        <form action="/admin/users" method="get">
            <input type="text" name="search" placeholder="Search users..." value="{{ search or '' }}">
            {% if role %}
            <input type="hidden" name="role" value="{{ role }}">
            {% endif %}
            <button type="submit">Search</button>
        </form>
    </div>
    
    {% if users %}
        <table class="users-table">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Join Date</th>
                    <th>Articles Created</th>
                    <th>Edits</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr id="user-row-{{ user._id }}">
                    <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td>
                        {% if user.role == 'admin' %}
                            <span class="role-badge role-admin">Admin</span>
                        {% elif user.role == 'editor' %}
                            <span class="role-badge role-editor">Editor</span>
                        {% else %}
                            <span class="role-badge role-user">User</span>
                        {% endif %}
                    </td>
                    <td>{{ user.joinDate|strftime('%Y-%m-%d') }}</td>
                    <td>{{ user.contributions.articlesCreated }}</td>
                    <td>{{ user.contributions.editsPerformed }}</td>
                    <td>
                        <div class="user-actions">
                            <a href="/users/{{ user._id }}" class="action-button view-button">View</a>
                            <button class="action-button edit-button" onclick="openRoleModal('{{ user._id }}', '{{ user.username }}', '{{ user.role }}')">Change Role</button>
                            {% if current_user._id != user._id %}
                                <button class="action-button delete-button" onclick="confirmDeleteUser('{{ user._id }}', '{{ user.username }}')">Delete</button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <!-- Pagination -->
        {% if total > limit %}
        <div class="pagination">
            {% if skip > 0 %}
            <a href="?{% if role %}role={{ role }}&{% endif %}{% if search %}search={{ search }}&{% endif %}skip={{ max(0, skip - limit) }}&limit={{ limit }}" class="page-link">Previous</a>
            {% endif %}
            
            <span class="page-info">Showing {{ skip + 1 }}-{{ min(skip + limit, total) }} of {{ total }}</span>
            
            {% if skip + limit < total %}
            <a href="?{% if role %}role={{ role }}&{% endif %}{% if search %}search={{ search }}&{% endif %}skip={{ skip + limit }}&limit={{ limit }}" class="page-link">Next</a>
            {% endif %}
        </div>
        {% endif %}
    {% else %}
        <div class="no-users">
            <p>No users found.</p>
            {% if role or search %}
                <p>Try adjusting your filters.</p>
            {% endif %}
        </div>
    {% endif %}
</div>

<!-- Role Change Modal -->
<div id="role-modal" class="role-modal">
    <div class="role-modal-content">
        <span class="close">&times;</span>
        <h2>Change User Role</h2>
        
        <p>Changing role for user: <strong id="modal-username"></strong></p>
        
        <div class="role-selection">
            <div class="role-option">
                <input type="radio" id="role-user" name="role" value="user">
                <label for="role-user">Regular User</label>
                <p>Can create and edit their own articles, propose edits to others.</p>
            </div>
            
            <div class="role-option">
                <input type="radio" id="role-editor" name="role" value="editor">
                <label for="role-editor">Editor</label>
                <p>Can edit any article, approve/reject proposals, and manage content.</p>
            </div>
            
            <div class="role-option">
                <input type="radio" id="role-admin" name="role" value="admin">
                <label for="role-admin">Administrator</label>
                <p>Full control over the wiki, including user management and system settings.</p>
            </div>
        </div>
        
        <div class="form-actions">
            <button id="save-role" class="primary-button">Save Changes</button>
            <button id="cancel-role" class="cancel-button">Cancel</button>
        </div>
    </div>
</div>

<!-- Delete User Confirmation Modal -->
<div id="delete-user-modal" class="role-modal">
    <div class="role-modal-content">
        <span class="close">&times;</span>
        <h2>Confirm User Deletion</h2>
        
        <p>Are you sure you want to delete user: <strong id="delete-username"></strong>?</p>
        
        <div class="warning-box">
            <p>⚠️ This action will remove the user account and all associated data. This cannot be undone.</p>
        </div>
        
        <div class="form-actions">
            <button id="confirm-delete-user" class="delete-button">Delete User</button>
            <button id="cancel-delete-user" class="cancel-button">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('token');
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');
    const roleModal = document.getElementById('role-modal');
    const deleteUserModal = document.getElementById('delete-user-modal');
    
    // Variables to store current user info for modals
    let currentUserId = null;
    let currentUsername = null;
    
    // Close button handlers
    document.querySelectorAll('.close').forEach(close => {
        close.addEventListener('click', function() {
            closeAllModals();
        });
    });
    
    // Close modals when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target === roleModal || event.target === deleteUserModal) {
            closeAllModals();
        }
    });
    
    // Setup role modal buttons
    document.getElementById('save-role').addEventListener('click', function() {
        const selectedRole = document.querySelector('input[name="role"]:checked');
        
        if (!selectedRole) {
            showError('Please select a role');
            return;
        }
        
        if (!currentUserId) {
            showError('User ID not found');
            return;
        }
        
        changeUserRole(currentUserId, selectedRole.value);
    });
    
    document.getElementById('cancel-role').addEventListener('click', function() {
        closeAllModals();
    });
    
    // Setup delete user modal buttons
    document.getElementById('confirm-delete-user').addEventListener('click', function() {
        if (!currentUserId) {
            showError('User ID not found');
            return;
        }
        
        deleteUser(currentUserId);
    });
    
    document.getElementById('cancel-delete-user').addEventListener('click', function() {
        closeAllModals();
    });
    
    // Change user role function
    async function changeUserRole(userId, newRole) {
        try {
            if (!token) {
                showError('You must be logged in as an administrator to perform this action');
                return;
            }
            
            // Show loading state
            const saveButton = document.getElementById('save-role');
            const originalText = saveButton.textContent;
            saveButton.textContent = 'Saving...';
            saveButton.disabled = true;
            
            const response = await fetch(`/api/special/users/${userId}/role?role=${newRole}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.detail || 'Failed to change user role');
            }
            
            // Show success message
            showSuccess(`User role successfully changed to ${newRole}`);
            
            // Update the UI
            const userRow = document.getElementById(`user-row-${userId}`);
            if (userRow) {
                const roleCell = userRow.querySelector('td:nth-child(3)');
                if (roleCell) {
                    let badgeHTML = '';
                    
                    if (newRole === 'admin') {
                        badgeHTML = '<span class="role-badge role-admin">Admin</span>';
                    } else if (newRole === 'editor') {
                        badgeHTML = '<span class="role-badge role-editor">Editor</span>';
                    } else {
                        badgeHTML = '<span class="role-badge role-user">User</span>';
                    }
                    
                    roleCell.innerHTML = badgeHTML;
                }
            }
            
            // Close the modal
            closeAllModals();
        } catch (error) {
            console.error('Error changing user role:', error);
            showError(error.message || 'Failed to change user role');
        } finally {
            // Reset button state
            const saveButton = document.getElementById('save-role');
            saveButton.textContent = 'Save Changes';
            saveButton.disabled = false;
        }
    }
    
    // Delete user function
    async function deleteUser(userId) {
        try {
            if (!token) {
                showError('You must be logged in as an administrator to perform this action');
                return;
            }
            
            // Show loading state
            const deleteButton = document.getElementById('confirm-delete-user');
            const originalText = deleteButton.textContent;
            deleteButton.textContent = 'Deleting...';
            deleteButton.disabled = true;
            
            const response = await fetch(`/api/special/users/${userId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.detail || 'Failed to delete user');
            }
            
            // Show success message
            showSuccess('User successfully deleted');
            
            // Remove the user row from the table
            const userRow = document.getElementById(`user-row-${userId}`);
            if (userRow) {
                userRow.remove();
            }
            
            // Close the modal
            closeAllModals();
        } catch (error) {
            console.error('Error deleting user:', error);
            showError(error.message || 'Failed to delete user');
        } finally {
            // Reset button state
            const deleteButton = document.getElementById('confirm-delete-user');
            deleteButton.textContent = 'Delete User';
            deleteButton.disabled = false;
        }
    }
    
    // Helper functions
    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        successMessage.style.display = 'none';
        
        // Hide after 5 seconds
        setTimeout(() => {
            errorMessage.style.display = 'none';
        }, 5000);
    }
    
    function showSuccess(message) {
        successMessage.textContent = message;
        successMessage.style.display = 'block';
        errorMessage.style.display = 'none';
        
        // Hide after 5 seconds
        setTimeout(() => {
            successMessage.style.display = 'none';
        }, 5000);
    }
    
    function closeAllModals() {
        if (roleModal) roleModal.style.display = 'none';
        if (deleteUserModal) deleteUserModal.style.display = 'none';
    }
    
    // Global functions for opening modals
    window.openRoleModal = function(userId, username, currentRole) {
        currentUserId = userId;
        currentUsername = username;
        
        // Set user info in modal
        document.getElementById('modal-username').textContent = username;
        
        // Select the current role
        document.getElementById(`role-${currentRole}`).checked = true;
        
        // Show the modal
        roleModal.style.display = 'block';
    }
    
    window.confirmDeleteUser = function(userId, username) {
        currentUserId = userId;
        currentUsername = username;
        
        // Set user info in modal
        document.getElementById('delete-username').textContent = username;
        
        // Show the modal
        deleteUserModal.style.display = 'block';
    }
});
</script>
{% endblock %}
