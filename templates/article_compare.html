{% extends "base.html" %}

{% block title %}Compare Revisions: {{ article.title }} - Kryptopedia{% endblock %}

{% set active_page = 'articles' %}

{% block sidebar_extra %}
<h3>Article Actions</h3>
<ul>
    <li><a href="/articles/{{ article.slug }}">Current Version</a></li>
    <li><a href="/articles/{{ article._id }}/history">History</a></li>
</ul>

<div class="revision-info">
    <h3>Older Revision</h3>
    <dl>
        <dt>Date:</dt>
        <dd>{{ old_revision.createdAt|strftime('%Y-%m-%d %H:%M') }}</dd>
        
        <dt>Author:</dt>
        <dd>{{ old_revision.creatorUsername }}</dd>
    </dl>

    <h3>Newer Revision</h3>
    <dl>
        <dt>Date:</dt>
        <dd>{{ new_revision.createdAt|strftime('%Y-%m-%d %H:%M') }}</dd>
        
        <dt>Author:</dt>
        <dd>{{ new_revision.creatorUsername }}</dd>
        
        <dt>Comment:</dt>
        <dd>{{ new_revision.comment or "No comment" }}</dd>
    </dl>
</div>
{% endblock %}

{% block content %}
<div class="article-header">
    <h1>Compare Revisions: {{ article.title }}</h1>
    <div class="revision-banner">
        <div class="revision-notice">
            <strong>Note:</strong> You are comparing two revisions of this article.
            <a href="/articles/{{ article.slug }}">View current version</a>
        </div>
    </div>
</div>

<div class="comparison-actions">
    <div class="comparison-info">
        <p>Comparing revision from {{ old_revision.createdAt|strftime('%Y-%m-%d %H:%M') }} to {{ new_revision.createdAt|strftime('%Y-%m-%d %H:%M') }}</p>
    </div>
    <div class="comparison-buttons">
        <a href="/articles/{{ article._id }}/revisions/{{ old_revision._id }}" class="action-button">View Older Version</a>
        <a href="/articles/{{ article._id }}/revisions/{{ new_revision._id }}" class="action-button">View Newer Version</a>
    </div>
</div>

<div class="comparison-container">
    <div id="diff-viewer">
        Loading diff view...
    </div>
</div>

<div class="revision-actions">
    <a href="/articles/{{ article._id }}/history" class="action-button">Back to History</a>
    <a href="/articles/{{ article.slug }}" class="action-button">View Current Version</a>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .revision-banner {
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        padding: 10px 15px;
        margin: 15px 0;
        border-radius: 4px;
    }
    
    .revision-notice {
        color: #856404;
    }
    
    .revision-notice a {
        color: #0645ad;
        text-decoration: underline;
    }
    
    .revision-info {
        margin-top: 20px;
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
    }
    
    .revision-info h3 {
        margin-top: 15px;
        font-size: 16px;
    }
    
    .revision-info dt {
        font-weight: bold;
        margin-top: 8px;
    }
    
    .revision-info dd {
        margin-left: 10px;
        margin-bottom: 5px;
    }
    
    .comparison-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 20px 0;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 4px;
    }
    
    .comparison-info {
        color: #666;
    }
    
    .comparison-buttons {
        display: flex;
        gap: 10px;
    }
    
    .comparison-container {
        margin: 20px 0;
        padding: 15px;
        background-color: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
    }
    
    #diff-viewer {
        font-family: monospace;
        white-space: pre-wrap;
        line-height: 1.5;
    }
    
    .diff-added {
        background-color: #e6ffed;
        color: #22863a;
    }
    
    .diff-removed {
        background-color: #ffeef0;
        color: #cb2431;
        text-decoration: line-through;
    }
    
    .diff-header {
        color: #586069;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .revision-actions {
        margin-top: 30px;
        display: flex;
        gap: 10px;
    }
    
    .action-button {
        display: inline-block;
        padding: 8px 16px;
        background-color: #0645ad;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .action-button:hover {
        background-color: #053a7a;
        text-decoration: none;
    }
</style>
<!-- Include diff2html CSS from CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/diff2html/3.4.17/diff2html.min.css">
{% endblock %}

{% block extra_js %}
<!-- Include diff libraries from CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/diff/5.0.0/diff.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/diff2html/3.4.17/diff2html.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get the revisions content
    const oldContent = {{ old_revision.content|tojson }};
    const newContent = {{ new_revision.content|tojson }};
    
    // Generate diff
    const diffViewer = document.getElementById('diff-viewer');
    
    try {
        // Create a unified diff
        const diffString = Diff.createPatch(
            '{{ article.title }}',
            oldContent,
            newContent,
            'Old Revision',
            'New Revision'
        );
        
        // Convert to HTML with diff2html
        const diffHtml = Diff2Html.html(diffString, {
            drawFileList: false,
            matching: 'lines',
            outputFormat: 'side-by-side',
            renderNothingWhenEmpty: false
        });
        
        // Set the HTML
        diffViewer.innerHTML = diffHtml;
    } catch (error) {
        console.error('Error generating diff:', error);
        diffViewer.innerHTML = '<p>Error generating diff view. The content may be too large or complex.</p>' +
                              '<p>You can view each revision separately using the buttons above.</p>';
    }
});
</script>
{% endblock %}
