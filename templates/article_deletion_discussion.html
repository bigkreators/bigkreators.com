
<!-- File: templates/article_deletion_discussion.html (Enhanced with Criteria) -->
{% extends "base.html" %}

{% block title %}Deletion Discussion: {{ article.title }} - Kryptopedia{% endblock %}

{% set active_page = 'articles' %}

{% block extra_css %}
<style>
/* Previous styles... */

.deletion-criteria {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 20px;
    margin: 20px 0;
}

.criteria-levels {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 15px 0;
}

.criteria-level {
    padding: 15px;
    border-radius: 4px;
    text-align: center;
}

.level-1 { background-color: #d4edda; border: 1px solid #c3e6cb; }
.level-2 { background-color: #fff3cd; border: 1px solid #ffeaa7; }
.level-3 { background-color: #ffeaa7; border: 1px solid #ffc107; }
.level-4 { background-color: #f8d7da; border: 1px solid #f5c6cb; }

.criteria-title {
    font-weight: bold;
    margin-bottom: 8px;
}

.criteria-action {
    font-size: 12px;
    font-style: italic;
}

.policy-section {
    background-color: #e3f2fd;
    border: 1px solid #bbdefb;
    border-radius: 4px;
    padding: 20px;
    margin: 20px 0;
}

.policy-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin: 15px 0;
}

.valid-reasons, .invalid-reasons {
    padding: 15px;
    border-radius: 4px;
}

.valid-reasons {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
}

.invalid-reasons {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
}

.reason-category {
    margin: 15px 0;
}

.reason-category h5 {
    margin: 0 0 8px 0;
    color: #333;
    font-weight: bold;
}

.reason-category ul {
    margin: 5px 0;
    padding-left: 20px;
}

.reason-category li {
    margin-bottom: 3px;
    font-size: 14px;
}

.deletion-template {
    background-color: #f1f3f4;
    border: 1px solid #dadce0;
    border-radius: 4px;
    padding: 15px;
    margin: 15px 0;
    font-family: monospace;
    font-size: 13px;
}

.evaluation-checklist {
    background-color: #fff8e1;
    border: 1px solid #ffcc02;
    border-radius: 4px;
    padding: 20px;
    margin: 20px 0;
}

.checklist-item {
    display: flex;
    align-items: center;
    margin: 8px 0;
}

.checklist-item input[type="checkbox"] {
    margin-right: 10px;
}
</style>
{% endblock %}

{% block sidebar_extra %}
<h3>Article Actions</h3>
<ul>
    <li><a href="/articles/{{ article.slug }}">View Article</a></li>
    <li><a href="/articles/{{ article._id }}/history">History</a></li>
    <li><a href="/help/deletion-policy">Deletion Policy</a></li>
</ul>

<div class="deletion-criteria">
    <h3>üìã Deletion Criteria</h3>
    <div class="criteria-levels">
        <div class="criteria-level level-1">
            <div class="criteria-title">üü¢ Level 1</div>
            <div>Minor Issues</div>
            <div class="criteria-action">Edit/Improve</div>
        </div>
        <div class="criteria-level level-2">
            <div class="criteria-title">üü° Level 2</div>
            <div>Moderate Issues</div>
            <div class="criteria-action">Discuss First</div>
        </div>
        <div class="criteria-level level-3">
            <div class="criteria-title">üü† Level 3</div>
            <div>Serious Issues</div>
            <div class="criteria-action">Likely Deletion</div>
        </div>
        <div class="criteria-level level-4">
            <div class="criteria-title">üî¥ Level 4</div>
            <div>Critical Issues</div>
            <div class="criteria-action">Immediate Action</div>
        </div>
    </div>
    <p><a href="/help/deletion-policy">View full deletion policy ‚Üí</a></p>
</div>

<div class="deletion-request-info">
    <h3>Request Details</h3>
    <div class="request-details">
        <dt>Requested by:</dt>
        <dd>{{ deletion_request.requesterUsername }}</dd>
        
        <dt>Article by:</dt>
        <dd>{{ deletion_request.authorUsername }}</dd>
        
        <dt>Requested:</dt>
        <dd>{{ deletion_request.createdAt|strftime('%Y-%m-%d %H:%M') }}</dd>
        
        <dt>Reason:</dt>
        <dd>{{ deletion_request.reason }}</dd>
        
        {% if deletion_request.criterion %}
        <dt>Criterion:</dt>
        <dd>{{ deletion_request.criterion }}</dd>
        {% endif %}
        
        {% if deletion_request.evidence %}
        <dt>Evidence:</dt>
        <dd>{{ deletion_request.evidence }}</dd>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block content %}
<div class="article-header">
    <h1>Deletion Discussion: {{ article.title }}</h1>
    <div class="discussion-header">
        <div class="discussion-notice">
            <span class="icon">üóëÔ∏è</span>
            <strong>This article has been proposed for deletion.</strong> Please review the deletion criteria and community discussion below.
        </div>
    </div>
</div>

<!-- Deletion Policy Reference -->
<div class="policy-section">
    <h3>üìñ Deletion Policy Quick Reference</h3>
    <div class="policy-grid">
        <div class="valid-reasons">
            <h4>‚úÖ Valid Deletion Reasons</h4>
            <div class="reason-category">
                <h5>Policy Violations</h5>
                <ul>
                    <li>Copyright infringement</li>
                    <li>Spam or advertising</li>
                    <li>Personal attacks</li>
                    <li>Illegal content</li>
                </ul>
            </div>
            <div class="reason-category">
                <h5>Quality Issues</h5>
                <ul>
                    <li>No meaningful content</li>
                    <li>Incoherent/nonsensical</li>
                    <li>Test pages</li>
                    <li>Duplicate content</li>
                </ul>
            </div>
            <div class="reason-category">
                <h5>Scope Issues</h5>
                <ul>
                    <li>Off-topic content</li>
                    <li>Personal content</li>
                    <li>Non-encyclopedic</li>
                </ul>
            </div>
        </div>
        
        <div class="invalid-reasons">
            <h4>‚ùå Invalid Deletion Reasons</h4>
            <div class="reason-category">
                <h5>Content Disputes</h5>
                <ul>
                    <li>Disagreement with viewpoint</li>
                    <li>Political bias</li>
                    <li>Controversial topics</li>
                    <li>Style preferences</li>
                </ul>
            </div>
            <div class="reason-category">
                <h5>Fixable Issues</h5>
                <ul>
                    <li>Poor grammar/spelling</li>
                    <li>Incomplete information</li>
                    <li>Outdated information</li>
                    <li>Minor factual errors</li>
                </ul>
            </div>
            <div class="reason-category">
                <h5>Personal Reasons</h5>
                <ul>
                    <li>Don't like the author</li>
                    <li>Want to write own version</li>
                    <li>Topic doesn't interest you</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Evaluation Checklist -->
<div class="evaluation-checklist">
    <h3>üîç Evaluation Checklist</h3>
    <p>Before voting, consider these questions:</p>
    
    <div class="checklist-item">
        <input type="checkbox" id="check-1">
        <label for="check-1">Could this article be improved instead of deleted?</label>
    </div>
    <div class="checklist-item">
        <input type="checkbox" id="check-2">
        <label for="check-2">Does the deletion request cite specific policy violations?</label>
    </div>
    <div class="checklist-item">
        <input type="checkbox" id="check-3">
        <label for="check-3">Is the content within the wiki's scope?</label>
    </div>
    <div class="checklist-item">
        <input type="checkbox" id="check-4">
        <label for="check-4">Are there reliable sources that could be added?</label>
    </div>
    <div class="checklist-item">
        <input type="checkbox" id="check-5">
        <label for="check-5">Could the content be merged with another article?</label>
    </div>
</div>

<div class="status-message error-message" id="error-message"></div>
<div class="status-message success-message" id="success-message"></div>

<!-- Rest of the voting and discussion sections remain the same... -->

<!-- Voting Section -->
{% if user_info.type == 'authenticated' %}
<div class="voting-section">
    <h3>üìä Community Vote</h3>
    <p><strong>Consider the deletion criteria above before voting.</strong> Focus on whether the article violates policies, not personal preferences.</p>
    
    <div class="vote-buttons">
        <button id="vote-delete" class="vote-button vote-delete" onclick="vote('delete')">
            üóëÔ∏è Delete Article
        </button>
        <button id="vote-keep" class="vote-button vote-keep" onclick="vote('keep')">
            üíæ Keep Article
        </button>
    </div>
    
    <div class="vote-counts">
        <div class="vote-count delete-votes">
            <span id="delete-count">{{ deletion_request.votes.delete|length }}</span> votes to delete
        </div>
        <div class="vote-count keep-votes">
            <span id="keep-count">{{ deletion_request.votes.keep|length }}</span> votes to keep
        </div>
    </div>
</div>
{% endif %}

<!-- Discussion Comments -->
<div class="discussion-comments">
    <h3>üí¨ Discussion</h3>
    <p><strong>Guidelines:</strong> Focus on content, not contributors. Cite specific policies. Provide evidence for claims.</p>
    
    <div class="deletion-template">
        <strong>Use this template for structured feedback:</strong><br>
        <strong>Criterion:</strong> [Which deletion reason applies?]<br>
        <strong>Evidence:</strong> [Specific examples or policy violations]<br>
        <strong>Alternative:</strong> [Could the article be improved instead?]<br>
        <strong>Recommendation:</strong> [Delete/Keep/Improve]
    </div>
    
    {% if deletion_request.discussionComments %}
        {% for comment in deletion_request.discussionComments %}
        <div class="comment">
            <div class="comment-header">
                <span class="comment-author">{{ comment.username }}</span>
                <span class="comment-time">{{ comment.timestamp|strftime('%Y-%m-%d %H:%M') }}</span>
            </div>
            <div class="comment-content">{{ comment.comment }}</div>
        </div>
        {% endfor %}
    {% else %}
        <p>No comments yet. Be the first to share your analysis based on the deletion criteria!</p>
    {% endif %}
    
    <!-- Add Comment Form -->
    {% if user_info.type == 'authenticated' %}
    <div class="add-comment">
        <h4>Add Your Analysis</h4>
        <p>Please reference specific deletion criteria and provide evidence for your position.</p>
        <form class="comment-form" onsubmit="addComment(event)">
            <textarea id="comment-text" placeholder="Use the template above to structure your feedback..." required></textarea>
            <button type="submit">Post Analysis</button>
        </form>
    </div>
    {% else %}
    <div class="add-comment">
        <p>You must be logged in to participate in the discussion.</p>
        <button onclick="showLoginModal()" class="primary-button">Log In</button>
    </div>
    {% endif %}
</div>

<!-- Resolution Section (Author/Admin Only) -->
{% if user_info.type == 'authenticated' and (user_info.user._id == deletion_request.authorId or user_info.user.role == 'admin') %}
<div class="resolution-section">
    <h3>‚öñÔ∏è Resolve Discussion</h3>
    <p><strong>Consider the community input and deletion criteria before deciding:</strong></p>
    
    <div class="resolution-buttons">
        <button class="approve-button" onclick="resolveDiscussion('approve_deletion')">
            ‚úÖ Approve Deletion
        </button>
        <button class="reject-button" onclick="resolveDiscussion('reject_deletion')">
            ‚ùå Reject Deletion
        </button>
    </div>
    
    <div style="margin-top: 15px;">
        <label for="resolution-comment">Resolution reasoning (required):</label>
        <textarea id="resolution-comment" placeholder="Explain your decision based on the deletion criteria and community input..." required style="width: 100%; height: 80px; margin-top: 5px; padding: 8px;"></textarea>
    </div>
</div>
{% endif %}

<!-- Article Preview -->
<div style="margin: 30px 0; padding: 20px; border: 1px solid #ddd; border-radius: 4px;">
    <h3>üìÑ Article Content Under Review</h3>
    <div style="max-height: 300px; overflow-y: auto; background-color: #f8f9fa; padding: 15px; border-radius: 4px;">
        {{ article.content|safe }}
    </div>
    <p style="margin-top: 10px;">
        <a href="/articles/{{ article.slug }}" target="_blank">View full article ‚Üí</a> | 
        <a href="/articles/{{ article._id }}/history" target="_blank">View edit history ‚Üí</a>
    </p>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Enhanced JavaScript with validation for criteria-based decisions

function vote(voteType) {
    const token = localStorage.getItem('token');
    if (!token) {
        showError('You must be logged in to vote.');
        return;
    }
    
    // Show criteria reminder
    const action = voteType === 'delete' ? 'delete' : 'keep';
    const message = `Are you sure you want to vote to ${action} this article?\n\nMake sure your decision is based on the deletion criteria, not personal preference.`;
    
    if (!confirm(message)) {
        return;
    }
    
    fetch('/api/articles/{{ article._id }}/deletion-discussion/vote', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ vote: voteType })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.detail || 'Failed to record vote');
            });
        }
        return response.json();
    })
    .then(data => {
        showSuccess(`Vote recorded: ${action} article`);
        setTimeout(() => window.location.reload(), 1000);
    })
    .catch(error => {
        showError(error.message);
    });
}

function resolveDiscussion(decision) {
    const token = localStorage.getItem('token');
    if (!token) {
        showError('You must be logged in to resolve discussions.');
        return;
    }
    
    const comment = document.getElementById('resolution-comment').value.trim();
    if (!comment) {
        showError('Please provide reasoning for your decision.');
        return;
    }
    
    const actionText = decision === 'approve_deletion' ? 'approve deletion' : 'reject deletion';
    
    if (!confirm(`Are you sure you want to ${actionText} of this article?\n\nYour reasoning: ${comment}`)) {
        return;
    }
    
    fetch('/api/articles/{{ article._id }}/deletion-discussion/resolve', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ 
            decision: decision,
            comment: comment 
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.detail || 'Failed to resolve discussion');
            });
        }
        return response.json();
    })
    .then(data => {
        showSuccess(data.message);
        setTimeout(() => {
            window.location.href = '/articles/{{ article.slug }}';
        }, 2000);
    })
    .catch(error => {
        showError(error.message);
    });
}

function showError(message) {
    const errorDiv = document.getElementById('error-message');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    document.getElementById('success-message').style.display = 'none';
    errorDiv.scrollIntoView({ behavior: 'smooth' });
}

function showSuccess(message) {
    const successDiv = document.getElementById('success-message');
    successDiv.textContent = message;
    successDiv.style.display = 'block';
    document.getElementById('error-message').style.display = 'none';
}

function showLoginModal() {
    const loginModal = document.getElementById('login-modal');
    if (loginModal) {
        loginModal.style.display = 'block';
    } else {
        window.location.href = '/login';
    }
}
</script>
{% endblock %}
