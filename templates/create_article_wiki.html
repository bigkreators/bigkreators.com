<!-- File: templates/create_article_wiki.html -->
{% extends "base.html" %}

{% block title %}Create Article - Kryptopedia{% endblock %}

{% set active_page = 'contribute' %}

{% block sidebar_extra %}
<h3>Article Guidelines</h3>
<ul>
    <li><a href="/help/formatting">Wiki Formatting Guide</a></li>
    <li><a href="/help/references">Adding References</a></li>
    <li><a href="/help/media">Adding Media</a></li>
    <li><a href="/help/categories">Using Categories</a></li>
</ul>

<h3>Quick Help</h3>
<ul>
    <li>Use '''text''' for <strong>bold text</strong></li>
    <li>Use ''text'' for <em>italic text</em></li>
    <li>Use == Heading == for section headers</li>
    <li>Use [[Link]] for internal links</li>
    <li>Use [https://example.com Text] for external links</li>
    <li>Use * for bullet lists, # for numbered lists</li>
</ul>
{% endblock %}

{% block content %}
<h1>Create a New Article</h1>

<!-- Mode toggle -->
<div class="mode-toggle">
    <button class="mode-toggle-button active" data-mode="wiki">Wiki Mode</button>
    <button class="mode-toggle-button" data-mode="html" onclick="switchToHtmlMode()">HTML Mode</button>
</div>

<div id="login-message" class="login-required-message" style="display: none;">
    <p>You need to be logged in to create articles.</p>
    <button id="login-to-create" class="primary-button">Login</button>
</div>

<!-- Status messages -->
<div id="error-message" class="status-message error-message" style="display: none;"></div>
<div id="success-message" class="status-message success-message" style="display: none;"></div>

<form id="create-article-form" style="display: none;">
    <div class="form-section">
        <h3>Article Basics</h3>
        
        <div class="form-group">
            <label for="article-title">Title:</label>
            <input type="text" id="article-title" name="title" required>
        </div>
        
        <div class="form-group">
            <label for="article-summary">Summary:</label>
            <textarea id="article-summary" name="summary" rows="3" required></textarea>
            <p class="help-text">A brief description of the article. This will be used as the short description.</p>
        </div>
    </div>
    
    <div class="form-section">
        <h3>Article Content</h3>
        <p class="help-text">Use wiki markup to format your article. The toolbar above provides common formatting options.</p>

        <div class="form-group">
            <label for="article-content">Content:</label>
            <div class="wiki-editor-container">
                <div class="wiki-editor-toolbar"></div>
                <textarea id="article-content" name="content" required></textarea>
            </div>
        </div>
        
        <div class="wiki-preview-area" style="display: none;"></div>
    </div>
    
    <div class="form-section">
        <h3>Article Metadata</h3>
        
        <div class="form-group">
            <label for="article-categories">Categories (comma-separated):</label>
            <input type="text" id="article-categories" name="categories">
            <p class="help-text">Categories help organize articles and make them easier to find.</p>
        </div>
        
        <div class="form-group">
            <label for="article-tags">Tags (comma-separated):</label>
            <input type="text" id="article-tags" name="tags">
            <p class="help-text">Tags provide additional keywords to help in searching and related articles.</p>
        </div>
        
        <div class="form-group metadata-checkboxes">
            <label>Article Contains:</label>
            <div>
                <input type="checkbox" id="has-audio" name="hasAudio">
                <label for="has-audio">Audio</label>
            </div>
            <div>
                <input type="checkbox" id="has-special-symbols" name="hasSpecialSymbols">
                <label for="has-special-symbols">Special Symbols</label>
            </div>
            <div>
                <input type="checkbox" id="contains-made-up-content" name="containsMadeUpContent">
                <label for="contains-made-up-content">Contains Made-Up Content (fictional, speculative)</label>
            </div>
        </div>
    </div>
    
    <!-- Edit Summary for New Articles -->
    <div class="form-section">
        <div class="form-group" style="background-color: #e8f5e8; border: 2px solid #28a745; border-radius: 8px; padding: 15px; margin: 20px 0;">
            <label for="edit-comment" style="font-weight: bold; color: #155724; display: block; margin-bottom: 8px;">
                üìù Creation Summary:
            </label>
            <input type="text" id="edit-comment" name="editComment" value="New article" required style="width: 100%; padding: 10px; border: 2px solid #28a745; border-radius: 4px; font-size: 14px;">
            <p class="help-text" style="color: #155724; font-size: 13px; margin-top: 5px; font-style: italic;">
                This will appear in the article's revision history. Default is "New article" but you can customize it.
            </p>
        </div>
    </div>
    
    <div class="form-actions">
        <button type="submit" id="create-article" class="primary-button">Create Article</button>
        <button type="button" id="preview-button" class="preview-button">Show Preview</button>
        <a href="/articles" class="cancel-button">Cancel</a>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<!-- Include wiki editor module -->
<script type="module">
    import { initializeWikiEditor } from '/static/js/wiki-editor/index.js';
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Wiki editor initialization starting...');
        
        // Initialize the wiki editor
        const form = document.getElementById('create-article-form');
        if (form) {
            try {
                initializeWikiEditor(form);
                console.log('Wiki editor initialized successfully');
            } catch (error) {
                console.error('Error initializing wiki editor:', error);
            }
        } else {
            console.error('Could not find create-article-form');
        }
    });
</script>

<script>
    function switchToHtmlMode() {
        const currentUrl = new URL(window.location);
        currentUrl.searchParams.set('mode', 'html');
        window.location.href = currentUrl.toString();
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Check if user is logged in
        const token = localStorage.getItem('token');
        const loginMessage = document.getElementById('login-message');
        const createForm = document.getElementById('create-article-form');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');

        // Handle auth state
        if (!token) {
            loginMessage.style.display = 'block';
            createForm.style.display = 'none';
            
            // Setup login button
            document.getElementById('login-to-create').addEventListener('click', function() {
                const loginModal = document.getElementById('login-modal');
                if (loginModal) {
                    loginModal.style.display = 'block';
                } else {
                    // Fallback: redirect to login page
                    window.location.href = '/login';
                }
            });
        } else {
            loginMessage.style.display = 'none';
            createForm.style.display = 'block';
            
            // Preview button functionality is handled by the wiki editor module
            
            // Handle form submission
            createForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Clear previous error messages
                hideMessages();
                
                // Get form values
                const articleTitle = document.getElementById('article-title').value.trim();
                const articleSummary = document.getElementById('article-summary').value.trim();
                const articleContent = document.getElementById('article-content').value.trim();
                const categoriesInput = document.getElementById('article-categories').value;
                const tagsInput = document.getElementById('article-tags').value;
                
                // Get metadata checkboxes
                const hasAudio = document.getElementById('has-audio').checked;
                const hasSpecialSymbols = document.getElementById('has-special-symbols').checked;
                const containsMadeUpContent = document.getElementById('contains-made-up-content').checked;
                
                const editComment = document.getElementById('edit-comment').value.trim();
                
                // Validation - now includes editComment with default value
                let validationErrors = [];
                
                if (!articleTitle) {
                    validationErrors.push('Article title is required');
                }
                if (!articleSummary) {
                    validationErrors.push('Article summary is required');
                }
                if (!articleContent) {
                    validationErrors.push('Article content is required');
                }
                if (!editComment) {
                    validationErrors.push('Creation summary is required');
                }
                
                if (validationErrors.length > 0) {
                    showError('Please fix the following issues:\n‚Ä¢ ' + validationErrors.join('\n‚Ä¢ '));
                    return;
                }
                
                // Process categories and tags
                const categories = categoriesInput.split(',')
                    .map(item => item.trim())
                    .filter(item => item.length > 0);
                    
                const tags = tagsInput.split(',')
                    .map(item => item.trim())
                    .filter(item => item.length > 0);
                
                // Show loading state
                const createButton = document.getElementById('create-article');
                const originalText = createButton.textContent;
                createButton.innerHTML = '<span class="loading-indicator"></span> Creating...';
                createButton.disabled = true;
                
                // Prepare article data
                const articleData = {
                    title: articleTitle,
                    summary: articleSummary,
                    content: articleContent,
                    categories: categories,
                    tags: tags,
                    metadata: {
                        hasAudio: hasAudio,
                        hasSpecialSymbols: hasSpecialSymbols,
                        containsMadeUpContent: containsMadeUpContent
                    },
                    editComment: editComment // Include the creation summary
                };
                
                // Send create request
                fetch('/api/articles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(articleData)
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers);
                    
                    // Accept both 200 (OK) and 201 (Created) as success
                    if (response.status === 200 || response.status === 201) {
                        return response.json();
                    } else if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.detail || `HTTP ${response.status}: Failed to create article`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Article creation response:', data);
                    showSuccess('Article created successfully!');
                    
                    // Redirect to the new article after a delay
                    setTimeout(() => {
                        // Use the slug if available, otherwise construct URL from title
                        const slug = data.slug || data.title.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                        window.location.href = `/articles/${slug}`;
                    }, 2000);
                })
                .catch(error => {
                    console.error('Error creating article:', error);
                    console.error('Full error object:', error);
                    showError('Failed to create article: ' + error.message);
                })
                .finally(() => {
                    // Reset button state
                    createButton.textContent = originalText;
                    createButton.disabled = false;
                });
            });
        }
        
        // Helper functions for showing messages
        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            
            // Scroll to top to ensure message is visible
            window.scrollTo(0, 0);
            
            // Hide after 5 seconds
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
            
            // Scroll to top to ensure message is visible
            window.scrollTo(0, 0);
        }
        
        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }
    });
</script>
{% endblock %}
