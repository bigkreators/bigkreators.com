<!-- File: templates/article_wiki.html -->
{% extends "base.html" %}

{% block title %}{{ article.title }} - Kryptopedia{% endblock %}

{% set active_page = 'articles' %}

{% block extra_css %}
<link rel="stylesheet" href="/static/wiki-style.css">
<style>
    .wiki-article {
        padding: 20px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .wiki-short-description {
        font-style: italic;
        color: #666;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eaecf0;
    }
    
    .wiki-article h1, .wiki-article h2, .wiki-article h3,
    .wiki-article h4, .wiki-article h5, .wiki-article h6 {
        margin-top: 1.5em;
        margin-bottom: 0.5em;
        border-bottom: 1px solid #eaecf0;
        padding-bottom: 0.3em;
    }
    
    .wiki-article h1 { font-size: 1.8em; }
    .wiki-article h2 { font-size: 1.6em; }
    .wiki-article h3 { font-size: 1.4em; }
    .wiki-article h4 { font-size: 1.2em; }
    .wiki-article h5 { font-size: 1.1em; }
    .wiki-article h6 { font-size: 1em; }
    
    .wiki-article p {
        margin-bottom: 1em;
        line-height: 1.6;
    }
    
    .wiki-article ul, .wiki-article ol {
        margin: 1em 0;
        padding-left: 2em;
    }
    
    .wiki-article li {
        margin-bottom: 0.5em;
    }
    
    .wiki-article a {
        color: #0645ad;
        text-decoration: none;
    }
    
    .wiki-article a:hover {
        text-decoration: underline;
    }
    
    .wiki-infobox {
        float: right;
        margin: 0 0 1em 1em;
        border: 1px solid #a2a9b1;
        background-color: #f8f9fa;
        width: 300px;
        border-collapse: collapse;
    }
    
    .wiki-infobox th, .wiki-infobox td {
        padding: 8px;
        border: 1px solid #a2a9b1;
    }
    
    .wiki-infobox-title {
        font-size: 1.2em;
        text-align: center;
        background-color: #eaecf0;
    }
    
    .wiki-infobox-image {
        text-align: center;
    }
    
    .wiki-infobox-image img {
        max-width: 100%;
    }
    
    .wiki-infobox-label {
        text-align: left;
        background-color: #eaecf0;
        width: 40%;
    }
    
    .wiki-table {
        border-collapse: collapse;
        margin: 1em 0;
    }
    
    .wiki-table th, .wiki-table td {
        padding: 8px;
        border: 1px solid #a2a9b1;
    }
    
    .wiki-table th {
        background-color: #eaecf0;
    }
    
    .wiki-table caption {
        font-weight: bold;
        padding: 8px;
    }
    
    .wiki-image {
        margin: 1em 0;
        display: table;
    }
    
    .wiki-image img {
        max-width: 100%;
    }
    
    .wiki-image-caption {
        display: table-caption;
        caption-side: bottom;
        text-align: center;
        font-size: 0.9em;
        padding: 5px;
        color: #666;
    }
    
    .wiki-image.thumb {
        border: 1px solid #c8ccd1;
        padding: 3px;
        background-color: #f8f9fa;
    }
    
    .wiki-image.center {
        margin-left: auto;
        margin-right: auto;
    }
    
    .wiki-image.right {
        float: right;
        clear: right;
        margin: 0 0 1em 1em;
    }
    
    .wiki-image.left {
        float: left;
        clear: left;
        margin: 0 1em 1em 0;
    }
    
    .wiki-reference {
        font-size: 0.8em;
        vertical-align: super;
        line-height: 0;
    }
    
    .wiki-references {
        margin-top: 2em;
        padding-top: 1em;
        border-top: 1px solid #eaecf0;
    }
    
    .wiki-references h2 {
        font-size: 1.5em;
        margin-top: 0;
    }
    
    .wiki-references ol {
        font-size: 0.9em;
    }
    
    .wiki-quote {
        margin: 1em 0;
        padding: 1em;
        background-color: #f8f9fa;
        border-left: 3px solid #c8ccd1;
    }
    
    .wiki-quote footer {
        margin-top: 0.5em;
        font-style: italic;
    }
    
    .article-warning {
        background-color: #fef6e7;
        border: 1px solid #ffa500;
        padding: 10px 15px;
        margin: 15px 0;
        border-radius: 4px;
    }
    
    .article-metadata {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eaecf0;
        font-size: 0.9em;
        color: #666;
    }
</style>
{% endblock %}

{% block sidebar_extra %}
<h3>Article Tools</h3>
<ul>
    <li><a href="/edit-article-wiki/{{ article._id }}" id="edit-article-wiki" class="auth-required">Edit Article</a></li>
    <li><a href="/articles/{{ article._id }}/propose-wiki" id="propose-edit-wiki">Propose Edit</a></li>
    <li><a href="/articles/{{ article._id }}/history" id="article-history">History</a></li>
    <li><a href="/articles/{{ article._id }}/proposals" id="article-proposals">View Proposals</a></li>
    <li><a href="/articles/{{ article._id }}/talk" id="article-talk">Discussion</a></li>
    <li><a href="/articles/{{ article._id }}/reward" id="reward-article" class="auth-required">Reward Contributor</a></li>
</ul>

<h3>Page Information</h3>
<ul>
    <li>Created: {{ article.createdAt|strftime('%Y-%m-%d') }}</li>
    <li>Last Updated: {{ article.lastUpdatedAt|strftime('%Y-%m-%d') or article.createdAt|strftime('%Y-%m-%d') }}</li>
    <li>Views: {{ article.views }}</li>
</ul>
{% endblock %}

{% block content %}
<div class="article-header">
    <h1>
        {{ article.title }}
        {% if current_user and (current_user.role == 'admin' or current_user.role == 'editor') %}
            {% if article.status == 'published' %}
                <span class="article-status-indicator status-published">Published</span>
            {% elif article.status == 'hidden' %}
                <span class="article-status-indicator status-hidden">Hidden</span>
            {% elif article.status == 'archived' %}
                <span class="article-status-indicator status-archived">Archived</span>
            {% elif article.status == 'draft' %}
                <span class="article-status-indicator status-draft">Draft</span>
            {% endif %}
        {% endif %}
    </h1>
    
    {% if article.status != 'published' %}
    <div class="article-warning">
        <p><strong>Note:</strong> This article is currently {{ article.status }}. It is not visible to regular users.</p>
    </div>
    {% endif %}
    
    {% if short_description %}
    <div class="wiki-short-description">
        {{ short_description }}
    </div>
    {% endif %}
</div>

<div class="wiki-article">
    {{ parsed_content|safe }}
</div>

{% if article.categories or article.tags %}
<div class="article-metadata">
    {% if article.categories %}
    <div class="article-categories">
        <strong>Categories:</strong>
        {% for category in article.categories %}
        <a href="/articles?category={{ category }}" class="category-tag">{{ category }}</a>
        {% endfor %}
    </div>
    {% endif %}
    
    {% if article.tags %}
    <div class="article-tags">
        <strong>Tags:</strong>
        {% for tag in article.tags %}
        <a href="/articles?tag={{ tag }}" class="tag">{{ tag }}</a>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endif %}

<div class="article-footer">
    <div class="article-actions">
        <button id="propose-edit-button" class="action-button" onclick="window.location.href='/articles/{{ article._id }}/propose-wiki'">Propose Edit</button>
        <button id="edit-button" class="action-button auth-required" onclick="window.location.href='/edit-article-wiki/{{ article._id }}'">Edit Article</button>
        <button id="reward-button" class="action-button auth-required">Reward Author</button>
        <button id="talk-button" class="action-button" onclick="window.location.href='/articles/{{ article._id }}/talk'">Discussion</button>
        <button id="share-button" class="action-button">Share</button>
        <button id="manage-button" class="action-button manage-button admin-required">Manage Article</button>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Include modals from the original article.html template -->
<!-- Reward Modal -->
<div id="reward-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Reward Contributor</h2>
        <p>Show appreciation for this content by rewarding the contributor.</p>
        <form id="reward-form">
            <input type="hidden" id="article-id" value="{{ article._id }}">
            <div class="form-group">
                <label for="reward-type">Reward Type:</label>
                <select id="reward-type" name="rewardType">
                    <option value="helpful">Helpful</option>
                    <option value="insightful">Insightful</option>
                    <option value="comprehensive">Comprehensive</option>
                </select>
            </div>
            <div class="form-group">
                <label for="points">Points:</label>
                <input type="number" id="points" name="points" min="1" max="10" value="5">
            </div>
            <button type="submit">Give Reward</button>
        </form>
    </div>
</div>

<!-- Share Modal -->
<div id="share-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Share Article</h2>
        <p>Share this article with others:</p>
        <div class="form-group">
            <label for="share-url">Article URL:</label>
            <input type="text" id="share-url" value="{{ request.url }}" readonly>
            <button id="copy-url">Copy</button>
        </div>
    </div>
</div>

<!-- Article Management Modal -->
<div id="article-management-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Article Management</h2>
        
        <div class="status-section">
            <h3>Change Article Status</h3>
            <p>Current status: <span class="article-status">{{ article.status or "published" }}</span></p>
            
            <div class="status-buttons">
                <button id="publish-article" class="status-button {% if article.status == 'published' %}active{% endif %}" data-status="published">Published</button>
                <button id="hide-article" class="status-button {% if article.status == 'hidden' %}active{% endif %}" data-status="hidden">Hidden</button>
                <button id="archive-article" class="status-button {% if article.status == 'archived' %}active{% endif %}" data-status="archived">Archived</button>
                <button id="draft-article" class="status-button {% if article.status == 'draft' %}active{% endif %}" data-status="draft">Draft</button>
            </div>
            
            <div class="status-descriptions">
                <p><strong>Published:</strong> Visible to all users</p>
                <p><strong>Hidden:</strong> Temporarily hidden from users, but not archived</p>
                <p><strong>Archived:</strong> Removed from listings but still accessible by direct URL</p>
                <p><strong>Draft:</strong> Only visible to editors and admins</p>
            </div>
        </div>
        
        <hr>
        
        <div class="danger-section">
            <h3>Danger Zone</h3>
            <p>These actions cannot be undone.</p>
            
            <button id="delete-article" class="danger-button">Permanently Delete Article</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-confirmation-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Confirm Permanent Deletion</h2>
        
        <div class="confirmation-content">
            <p>You are about to <strong>permanently delete</strong> this article:</p>
            <p class="article-title-confirm">{{ article.title }}</p>
            
            <div class="warning-box">
                <p>⚠️ This action cannot be undone. All revisions, proposals, and rewards associated with this article will also be deleted.</p>
            </div>
            
            <div class="form-group">
                <label for="delete-confirmation">Type "DELETE" to confirm:</label>
                <input type="text" id="delete-confirmation" placeholder="DELETE">
            </div>
            
            <div class="form-actions">
                <button id="confirm-delete" class="danger-button" disabled>Permanently Delete</button>
                <button id="cancel-delete" class="cancel-button">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if user is logged in
    const token = localStorage.getItem('token');
    const authElements = document.querySelectorAll('.auth-required');
    const adminElements = document.querySelectorAll('.admin-required');
    
    if (token) {
        // User is logged in, show auth-required elements
        authElements.forEach(element => {
            element.style.display = 'inline-block';
        });
        
        // Check if user is admin/editor for admin-required elements
        fetch('/api/auth/me', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to get user info');
            }
            return response.json();
        })
        .then(user => {
            // Only show admin-required elements for admins/editors
            if (user.role === 'admin' || user.role === 'editor') {
                adminElements.forEach(element => {
                    element.style.display = 'inline-block';
                });
            }
        })
        .catch(error => {
            console.error('Error checking user role:', error);
        });
    } else {
        // User is not logged in, hide auth-required and admin-required elements
        authElements.forEach(element => {
            element.style.display = 'none';
        });
        
        adminElements.forEach(element => {
            element.style.display = 'none';
        });
    }
    
    // Set up reward button
    const rewardButton = document.getElementById('reward-button');
    if (rewardButton) {
        rewardButton.addEventListener('click', function() {
            // Check if user is logged in
            if (!token) {
                // Not logged in, show login modal
                const loginModal = document.getElementById('login-modal');
                if (loginModal) loginModal.style.display = 'block';
                return;
            }
            
            // Show reward modal
            const rewardModal = document.getElementById('reward-modal');
            if (rewardModal) rewardModal.style.display = 'block';
        });
    }
    
    // Set up reward form submission
    const rewardForm = document.getElementById('reward-form');
    if (rewardForm) {
        rewardForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get form values
            const articleId = document.getElementById('article-id').value;
            const rewardType = document.getElementById('reward-type').value;
            const points = parseInt(document.getElementById('points').value);
            
            // Get token
            const token = localStorage.getItem('token');
            if (!token) {
                alert('You must be logged in to give rewards.');
                return;
            }
            
            // Create reward data
            const rewardData = {
                rewardType: rewardType,
                points: points
            };
            
            // Submit reward
            fetch(`/api/rewards/articles/${articleId}/rewards`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(rewardData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.detail || 'Failed to give reward');
                    });
                }
                return response.json();
            })
            .then(data => {
                alert('Reward given successfully!');
                const rewardModal = document.getElementById('reward-modal');
                if (rewardModal) rewardModal.style.display = 'none';
            })
            .catch(error => {
                console.error('Error giving reward:', error);
                alert(error.message || 'Failed to give reward. Please try again.');
            });
        });
    }
    
    // Set up share button
    const shareButton = document.getElementById('share-button');
    if (shareButton) {
        shareButton.addEventListener('click', function() {
            const shareModal = document.getElementById('share-modal');
            if (shareModal) shareModal.style.display = 'block';
        });
    }
    
    // Set up copy URL button
    const copyUrlButton = document.getElementById('copy-url');
    if (copyUrlButton) {
        copyUrlButton.addEventListener('click', function() {
            const shareUrl = document.getElementById('share-url');
            shareUrl.select();
            document.execCommand('copy');
            alert('URL copied to clipboard!');
        });
    }
    
    // Modal closing
    const closeButtons = document.querySelectorAll('.close');
    closeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const modal = this.closest('.modal');
            if (modal) modal.style.display = 'none';
        });
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    });

    // Article management functionality - add any additional management handlers here
    const articleManagementModal = document.getElementById('article-management-modal');
    const deleteConfirmationModal = document.getElementById('delete-confirmation-modal');
    const manageButton = document.getElementById('manage-button');
    const statusButtons = document.querySelectorAll('.status-button');
    const deleteArticleButton = document.getElementById('delete-article');
    const confirmDeleteButton = document.getElementById('confirm-delete');
    const cancelDeleteButton = document.getElementById('cancel-delete');
    const deleteConfirmationInput = document.getElementById('delete-confirmation');

    if (manageButton) {
        manageButton.addEventListener('click', function() {
            if (!token) {
                const loginModal = document.getElementById('login-modal');
                if (loginModal) loginModal.style.display = 'block';
                return;
            }
            
            if (articleManagementModal) {
                articleManagementModal.style.display = 'block';
            }
        });
    }

    if (statusButtons) {
        statusButtons.forEach(button => {
            button.addEventListener('click', function() {
                const newStatus = this.getAttribute('data-status');
                
                if (this.classList.contains('active')) {
                    return;
                }
                
                if (!confirm(`Are you sure you want to change the article status to "${newStatus}"?`)) {
                    return;
                }
                
                this.disabled = true;
                const originalText = this.textContent;
                this.textContent = `Updating...`;
                
                fetch(`/api/articles/{{ article._id }}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        status: newStatus
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to update article status');
                    }
                    return response.json();
                })
                .then(data => {
                    statusButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    const statusDisplay = document.querySelector('.article-status');
                    if (statusDisplay) {
                        statusDisplay.textContent = newStatus;
                    }
                    
                    alert(`Article status updated to "${newStatus}"`);
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                })
                .catch(error => {
                    console.error('Error updating article status:', error);
                    alert('Error updating article status: ' + error.message);
                })
                .finally(() => {
                    this.disabled = false;
                    this.textContent = originalText;
                });
            });
        });
    }

    if (deleteArticleButton) {
        deleteArticleButton.addEventListener('click', function() {
            if (articleManagementModal) {
                articleManagementModal.style.display = 'none';
            }
            
            if (deleteConfirmationModal) {
                deleteConfirmationModal.style.display = 'block';
            }
        });
    }

    if (deleteConfirmationInput) {
        deleteConfirmationInput.addEventListener('input', function() {
            if (this.value === 'DELETE') {
                confirmDeleteButton.disabled = false;
            } else {
                confirmDeleteButton.disabled = true;
            }
        });
    }

    if (confirmDeleteButton) {
        confirmDeleteButton.addEventListener('click', function() {
            if (deleteConfirmationInput.value !== 'DELETE') {
                return;
            }
            
            this.disabled = true;
            this.textContent = 'Deleting...';
            
            fetch(`/api/articles/{{ article._id }}?permanent=true`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete article');
                }
                return response.json();
            })
            .then(data => {
                alert('Article has been permanently deleted');
                window.location.href = '/';
            })
            .catch(error => {
                console.error('Error deleting article:', error);
                alert('Error deleting article: ' + error.message);
                this.disabled = false;
                this.textContent = 'Permanently Delete';
            });
        });
    }

    if (cancelDeleteButton) {
        cancelDeleteButton.addEventListener('click', function() {
            if (deleteConfirmationModal) {
                deleteConfirmationModal.style.display = 'none';
            }
            
            if (articleManagementModal) {
                articleManagementModal.style.display = 'block';
            }
            
            if (deleteConfirmationInput) {
                deleteConfirmationInput.value = '';
            }
            
            if (confirmDeleteButton) {
                confirmDeleteButton.disabled = true;
            }
        });
    }
});
</script>
{% endblock %}
