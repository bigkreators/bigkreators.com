<!-- File: templates/edit_article_wiki.html -->
{% extends "base.html" %}

{% block title %}Edit Article: {{ article.title }} - Kryptopedia{% endblock %}

{% set active_page = 'articles' %}

{% block sidebar_extra %}
<h3>Article Actions</h3>
<ul>
    <li><a href="/articles/{{ article.slug }}">View Article</a></li>
    <li><a href="/articles/{{ article._id }}/history">History</a></li>
    <li><a href="/articles/{{ article._id }}/move" class="auth-required">Move/Rename Article</a></li>
    <li><a href="/articles">All Articles</a></li>
</ul>

<h3>Wiki Formatting</h3>
<ul>
    <li>Use '''text''' for <strong>bold text</strong></li>
    <li>Use ''text'' for <em>italic text</em></li>
    <li>Use == Heading == for section headers</li>
    <li>Use [[Link]] for internal links</li>
    <li>Use [https://example.com Text] for external links</li>
    <li>Use * for bullet lists, # for numbered lists</li>
</ul>

<h3>Anonymous Editing</h3>
<div id="anonymous-info" style="display: none;">
    <p><strong>üìù Editing anonymously</strong></p>
    <p>Your IP address will be recorded with this edit. <a href="#" onclick="showLoginModal()">Log in</a> to edit with your username instead.</p>
    
    <h4>As an anonymous user, you can:</h4>
    <ul>
        <li>‚úÖ Edit articles</li>
        <li>‚úÖ Improve content</li>
        <li>‚úÖ Fix errors</li>
    </ul>
    
    <h4>To unlock more features:</h4>
    <ul>
        <li>üîê Create new articles</li>
        <li>üîê Upload files</li>
        <li>üîê Earn rewards</li>
        <li>üîê Move articles</li>
    </ul>
    
    <p><a href="#" onclick="showLoginModal()" class="primary-button">Create Account</a></p>
</div>
{% endblock %}

{% block content %}
<h1>Edit Article: {{ article.title }}</h1>

<!-- Anonymous user notice -->
<div id="anonymous-notice" class="notice-box" style="display: none;">
    <p><strong>üìù You're editing anonymously.</strong> Your IP address ({{ user_info.anonymized_ip if user_info and user_info.type == 'anonymous' else 'hidden' }}) will be recorded with this edit.</p>
    <p><a href="#" onclick="showLoginModal()">Log in</a> or <a href="/register">create an account</a> to edit with your username and access more features.</p>
</div>

<!-- Authenticated user notice -->
<div id="authenticated-notice" class="notice-box" style="display: none;">
    <p><strong>üë§ Editing as {{ user_info.display_name if user_info and user_info.type == 'authenticated' else 'user' }}.</strong></p>
</div>

<div class="status-message error-message" id="error-message"></div>
<div class="status-message success-message" id="success-message"></div>

<form id="edit-article-form">
    <!-- Title field removed - title can only be changed via move/rename -->
    
    <div class="form-section">
        <div class="form-group">
            <label for="article-summary">Summary:</label>
            <textarea id="article-summary" name="summary" rows="3" required>{{ article.summary }}</textarea>
            <p class="help-text">A brief description of the article. This will be used as the short description.</p>
        </div>
    </div>
    
    <div class="form-section">
        <div class="form-group">
            <label for="article-content">Content:</label>
            <div class="wiki-editor-container">
                <div class="wiki-editor-toolbar"></div>
                <textarea id="article-content" name="content" required>{{ article.content }}</textarea>
            </div>
        </div>
        
        <div class="wiki-preview-area" style="display: none;"></div>
    </div>
    
    <div class="form-section">
        <div class="form-group">
            <label for="article-categories">Categories (comma-separated):</label>
            <input type="text" id="article-categories" name="categories" value="{{ article.categories|join(', ') }}" class="tag-input">
            <p class="help-text">Categories help organize articles and make them easier to find.</p>
        </div>
        
        <div class="form-group">
            <label for="article-tags">Tags (comma-separated):</label>
            <input type="text" id="article-tags" name="tags" value="{{ article.tags|join(', ') }}" class="tag-input">
            <p class="help-text">Tags provide additional keywords to help in searching and related articles.</p>
        </div>
        
        <div class="form-group">
            <label for="edit-comment">Edit Summary:</label>
            <input type="text" id="edit-comment" name="editComment" placeholder="Briefly describe your changes" required>
            <p class="help-text">This will appear in the article's revision history.</p>
        </div>
    </div>
    
    <div class="form-actions">
        <button type="submit" id="save-article" class="primary-button">Save Changes</button>
        <button type="button" id="preview-button" class="preview-button">Show Preview</button>
        <a href="/articles/{{ article.slug }}" class="cancel-button">Cancel</a>
        <a href="/articles/{{ article._id }}/move" class="secondary-button auth-required">Move/Rename Article</a>
    </div>
</form>

<!-- Rate limit warning for anonymous users -->
<div id="rate-limit-warning" class="warning-box" style="display: none;">
    <p><strong>‚ö†Ô∏è Rate Limit Notice:</strong> Anonymous users are limited to 10 edits per hour to prevent abuse. <a href="#" onclick="showLoginModal()">Create an account</a> for unlimited editing.</p>
</div>

{% endblock %}

{% block extra_js %}
<script type="module">
    // Preload wiki editor modules for faster initialization
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Wiki mode page loading...');
        
        if (document.getElementById('article-content')) {
            console.log('üìù Found article-content textarea');
            
            // Explicitly load the CSS first
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = '/static/css/wiki-editor-toolbar.css';
            document.head.appendChild(link);
            console.log('üìã CSS loaded');
       
            // Import the editor module
            import('/static/js/wiki-editor/index.js')
                .then(module => {
                    console.log('üìö Wiki Editor modules loaded successfully');
                    
                    // REMOVED THE PROBLEMATIC CONDITIONAL CHECK
                    // OLD: if (document.querySelector('.wiki-editor-container')) {
                    // NEW: Always try to initialize
                    
                    const form = document.getElementById('edit-article-form') ||
                                 document.getElementById('create-article-form') ||
                                 document.getElementById('propose-edit-form');
                    
                    if (form) {
                        console.log(`üéØ Found form: ${form.id}`);
                        setTimeout(() => {
                            console.log('üîß Initializing wiki editor...');
                            module.initializeWikiEditor(form);
                            
                            // Verification after initialization
                            setTimeout(() => {
                                const toolbar = document.querySelector('.wiki-editor-toolbar');
                                const buttons = toolbar?.querySelectorAll('button');
                                
                                if (toolbar && buttons && buttons.length > 0) {
                                    console.log(`‚úÖ SUCCESS: Wiki editor loaded with ${buttons.length} buttons`);
                                    
                                    // Add visual success indicator
                                    const indicator = document.createElement('div');
                                    indicator.style.cssText = `
                                        position: fixed;
                                        top: 10px;
                                        right: 10px;
                                        background: green;
                                        color: white;
                                        padding: 8px 12px;
                                        border-radius: 4px;
                                        z-index: 9999;
                                        font-size: 14px;
                                        font-weight: bold;
                                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                                    `;
                                    indicator.textContent = `‚úÖ Wiki Editor Active (${buttons.length} buttons)`;
                                    document.body.appendChild(indicator);
                                    
                                    // Remove indicator after 5 seconds
                                    setTimeout(() => indicator.remove(), 5000);
                                } else {
                                    console.log('‚ùå FAILED: No toolbar or buttons found');
                                    
                                    // Add visual error indicator
                                    const indicator = document.createElement('div');
                                    indicator.style.cssText = `
                                        position: fixed;
                                        top: 10px;
                                        right: 10px;
                                        background: red;
                                        color: white;
                                        padding: 8px 12px;
                                        border-radius: 4px;
                                        z-index: 9999;
                                        font-size: 14px;
                                        font-weight: bold;
                                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                                    `;
                                    indicator.textContent = '‚ùå Wiki Editor Failed to Load';
                                    document.body.appendChild(indicator);
                                }
                            }, 500);
                            
                        }, 100);
                    } else {
                        console.log('‚ùå No suitable form found');
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error loading wiki editor:', error);
                    
                    // Add visual error indicator
                    const indicator = document.createElement('div');
                    indicator.style.cssText = `
                        position: fixed;
                        top: 10px;
                        right: 10px;
                        background: orange;
                        color: white;
                        padding: 8px 12px;
                        border-radius: 4px;
                        z-index: 9999;
                        font-size: 14px;
                        font-weight: bold;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    `;
                    indicator.textContent = '‚ö†Ô∏è Wiki Editor Load Error';
                    document.body.appendChild(indicator);
                });
        } else {
            console.log('‚ùå No article-content textarea found');
        }
    });
</script>


<style>
.notice-box {
    background-color: #f0f8ff;
    border: 1px solid #0066cc;
    border-radius: 4px;
    padding: 12px 16px;
    margin-bottom: 20px;
}

.warning-box {
    background-color: #fff8e1;
    border: 1px solid #ff9800;
    border-radius: 4px;
    padding: 12px 16px;
    margin-top: 20px;
}

.notice-box a, .warning-box a {
    color: #0066cc;
    text-decoration: none;
    font-weight: bold;
}

.notice-box a:hover, .warning-box a:hover {
    text-decoration: underline;
}

#anonymous-info {
    background-color: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 15px;
    margin-top: 15px;
}

#anonymous-info h4 {
    margin: 15px 0 8px 0;
    color: #333;
}

#anonymous-info ul {
    margin: 8px 0;
    padding-left: 20px;
}

#anonymous-info .primary-button {
    margin-top: 15px;
    padding: 8px 16px;
    background-color: #0066cc;
    color: white;
    border: none;
    border-radius: 4px;
    text-decoration: none;
    display: inline-block;
    cursor: pointer;
}

#anonymous-info .primary-button:hover {
    background-color: #0052a3;
}
</style>
{% endblock %}
