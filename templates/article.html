<!-- File: templates/article.html -->

{% extends "base.html" %}

{% block title %}{{ article.title }} - Kryptopedia{% endblock %}

{% block extra_head %}
<meta name="description" content="{{ article.summary or 'Learn about ' + article.title + ' on Kryptopedia' }}">
<meta name="keywords" content="{% if article.tags %}{{ article.tags|join(', ') }}{% endif %}">
<meta property="og:title" content="{{ article.title }}">
<meta property="og:description" content="{{ article.summary or 'Learn about ' + article.title + ' on Kryptopedia' }}">
<meta property="og:type" content="article">
<meta property="og:url" content="{{ request.url }}">
{% endblock %}

{% block extra_css %}
<style>
/* Enhanced styling combining both versions */
.vote-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 10px 0;
}

.vote-button {
    background: none;
    border: 2px solid #ddd;
    border-radius: 4px;
    padding: 8px 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    color: #666;
}

.vote-button:hover {
    border-color: #0645ad;
    color: #0645ad;
}

.vote-button.active.upvote {
    border-color: #28a745;
    color: #28a745;
    background-color: #f8fff9;
}

.vote-button.active.downvote {
    border-color: #dc3545;
    color: #dc3545;
    background-color: #fff8f8;
}

.vote-count {
    font-weight: bold;
    font-size: 1.2em;
    min-width: 30px;
    text-align: center;
}

.article-status-indicator {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 3px;
    font-size: 0.8em;
    font-weight: bold;
    margin-left: 10px;
}

.status-published { background-color: #d4edda; color: #155724; }
.status-hidden { background-color: #fff3cd; color: #856404; }
.status-archived { background-color: #f8d7da; color: #721c24; }
.status-draft { background-color: #d1ecf1; color: #0c5460; }

.article-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin: 20px 0;
}

.action-button {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    background-color: #0645ad;
    color: white;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    font-size: 14px;
    transition: background-color 0.2s;
}

.action-button:hover {
    background-color: #053d8c;
    text-decoration: none;
}

.action-button.manage-button {
    background-color: #6c757d;
}

.action-button.manage-button:hover {
    background-color: #545b62;
}

.article-meta {
    color: #666;
    font-size: 0.9em;
    margin: 10px 0;
}

.article-meta span {
    margin-right: 15px;
}

.category-tag, .tag {
    display: inline-block;
    padding: 4px 8px;
    margin: 2px 4px 2px 0;
    background-color: #e9ecef;
    color: #495057;
    text-decoration: none;
    border-radius: 3px;
    font-size: 0.9em;
}

.category-tag:hover, .tag:hover {
    background-color: #dee2e6;
    text-decoration: none;
}

.tag {
    background-color: #d1ecf1;
    color: #0c5460;
}

.article-content {
    line-height: 1.6;
    margin: 20px 0;
    font-size: 16px;
}

/* Enhanced content formatting */
.article-content h1, .article-content h2, .article-content h3,
.article-content h4, .article-content h5, .article-content h6 {
    margin-top: 25px;
    margin-bottom: 15px;
}

.article-content p {
    margin-bottom: 15px;
}

.article-content ul, .article-content ol {
    margin-bottom: 15px;
    padding-left: 30px;
}

.article-content blockquote {
    border-left: 4px solid #ddd;
    padding-left: 20px;
    margin: 20px 0;
    color: #666;
    font-style: italic;
}

.article-content table {
    border-collapse: collapse;
    width: 100%;
    margin: 20px 0;
}

.article-content th, .article-content td {
    border: 1px solid #ddd;
    padding: 8px 12px;
    text-align: left;
}

.article-content th {
    background-color: #f2f2f2;
    font-weight: bold;
}

/* Modal styling improvements */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border: none;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
}

.close:hover {
    color: #000;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.form-group input, .form-group select, .form-group textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.danger-button {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
}

.danger-button:hover {
    background-color: #c82333;
}

.danger-button:disabled {
    background-color: #6c757d;
    cursor: not-allowed;
}

.status-button {
    padding: 8px 16px;
    margin: 5px;
    border: 2px solid #ddd;
    background-color: white;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.status-button.active {
    border-color: #0645ad;
    background-color: #e3f2fd;
    color: #0645ad;
}

.warning-box {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    padding: 15px;
    border-radius: 4px;
    margin: 15px 0;
    color: #856404;
}

/* Content warning styles */
.content-warning {
    background-color: #fff3cd;
    border: 2px solid #ffeaa7;
    border-radius: 4px;
    padding: 15px;
    margin-bottom: 20px;
    color: #856404;
}

.raw-content-display {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    padding: 15px;
    margin-bottom: 15px;
    overflow-x: auto;
    max-height: 500px;
    overflow-y: auto;
}

.raw-content-display pre {
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Courier New', monospace;
    font-size: 0.9em;
    line-height: 1.4;
    color: #333;
}

.content-help {
    background-color: #e3f2fd;
    border: 1px solid #bbdefb;
    border-radius: 4px;
    padding: 15px;
    margin-bottom: 20px;
    color: #0c5460;
}

.no-content {
    text-align: center;
    padding: 40px 20px;
    background-color: #f8f9fa;
    border-radius: 4px;
    color: #666;
}

/* Responsive design */
@media (max-width: 768px) {
    .vote-container {
        justify-content: center;
    }
    
    .article-actions {
        flex-direction: column;
        align-items: center;
    }
    
    .action-button {
        width: 100%;
        text-align: center;
    }
    
    .modal-content {
        margin: 10% auto;
        width: 95%;
    }
}
</style>
{% endblock %}

{% block sidebar_extra %}
<!-- Enhanced sidebar combining both versions -->
<div class="article-sidebar">
    <div class="article-actions">
        <h3>Article Tools</h3>
        <ul class="list-unstyled">
            <li><a href="/edit-article/{{ article._id }}" id="edit-article" class="auth-required btn btn-outline-primary btn-sm mb-2">‚úèÔ∏è Edit Article</a></li>
            <li><a href="/articles/{{ article._id }}/propose" id="propose-edit" class="btn btn-outline-secondary btn-sm mb-2">üìù Propose Edit</a></li>
            <li><a href="/articles/{{ article._id }}/history" id="article-history" class="btn btn-outline-secondary btn-sm mb-2">üìú History</a></li>
            <li><a href="/articles/{{ article._id }}/proposals" id="article-proposals" class="btn btn-outline-info btn-sm mb-2">üìã View Proposals</a></li>
            <li><a href="/articles/{{ article._id }}/talk" class="btn btn-outline-info btn-sm mb-2">üí¨ Discussion</a></li>
            <li><a href="/articles/{{ article._id }}/reward" id="reward-article" class="auth-required btn btn-outline-success btn-sm mb-2">üèÜ Reward Contributor</a></li>
            {% if current_user and current_user.role in ['admin', 'editor'] %}
                {% if current_user._id == article.createdBy or current_user.role in ['admin', 'editor'] %}
                    <li><button onclick="showDeleteModal('{{ article._id }}')" class="btn btn-outline-danger btn-sm mb-2">
                        üóëÔ∏è Request Deletion
                    </button></li>
                {% endif %}
            {% endif %}
            <li><a href="/help/deletion-policy" class="btn btn-outline-info btn-sm mb-2">üìã Deletion Policy</a></li>
        </ul>
    </div>

    <div class="article-info mt-4">
        <h3>Article Information</h3>
        <dl>
            <dt>Created:</dt>
            <dd>{{ article.createdAt|strftime('%Y-%m-%d') if article.createdAt else 'Unknown' }}</dd>
            
            <dt>Last Updated:</dt>
            <dd>{{ (article.lastUpdatedAt or article.updatedAt)|strftime('%Y-%m-%d') if (article.lastUpdatedAt or article.updatedAt) else 'Unknown' }}</dd>
            
            {% if article.views %}
            <dt>Views:</dt>
            <dd>{{ article.views }}</dd>
            {% endif %}
            
            {% if article.categories %}
            <dt>Categories:</dt>
            <dd>
                {% for category in article.categories %}
                    <a href="/articles?category={{ category }}" class="badge bg-secondary text-decoration-none me-1">{{ category }}</a>
                {% endfor %}
            </dd>
            {% endif %}
            
            {% if article.tags %}
            <dt>Tags:</dt>
            <dd>
                {% for tag in article.tags %}
                    <a href="/articles?tag={{ tag }}" class="badge bg-light text-dark text-decoration-none me-1">{{ tag }}</a>
                {% endfor %}
            </dd>
            {% endif %}
        </dl>
    </div>

    {% if article.status and article.status != 'published' %}
    <div class="article-status mt-4">
        <h3>Status</h3>
        <span class="badge bg-warning">{{ article.status|title }}</span>
        {% if current_user and current_user.role in ['admin', 'editor'] %}
            <p class="small text-muted mt-2">This article is not publicly visible.</p>
        {% endif %}
    </div>
    {% endif %}

    {% if article.featured %}
    <div class="featured-status mt-4">
        <h3>Featured Article</h3>
        <span class="badge bg-success">‚≠ê Featured</span>
        {% if article.featured_until %}
            <p class="small text-muted mt-2">Featured until {{ article.featured_until|strftime('%Y-%m-%d') }}</p>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block content %}
<div class="article-header">
    <h1>
        {{ article.title }}
        {% if current_user and (current_user.role == 'admin' or current_user.role == 'editor') %}
            {% if article.status == 'published' %}
                <span class="article-status-indicator status-published">Published</span>
            {% elif article.status == 'hidden' %}
                <span class="article-status-indicator status-hidden">Hidden</span>
            {% elif article.status == 'archived' %}
                <span class="article-status-indicator status-archived">Archived</span>
            {% elif article.status == 'draft' %}
                <span class="article-status-indicator status-draft">Draft</span>
            {% endif %}
        {% endif %}
    </h1>
    
    <!-- Enhanced vote buttons with better styling -->
    <div class="vote-container">
        <button class="vote-button upvote" id="upvote-button" title="Upvote">
            <i class="fas fa-arrow-up"></i>
        </button>
        <span class="vote-count" id="vote-count">{{ article.upvotes|default(0) - article.downvotes|default(0) }}</span>
        <button class="vote-button downvote" id="downvote-button" title="Downvote">
            <i class="fas fa-arrow-down"></i>
        </button>
    </div>
    
    <div class="article-meta">
        <span>Views: {{ article.views }}</span>
        <span>Last updated: {{ article.lastUpdatedAt|strftime('%Y-%m-%d') or article.createdAt|strftime('%Y-%m-%d') }}</span>
    </div>
</div>

<!-- Enhanced status warnings -->
{% if article.status and article.status != 'published' %}
    <div class="alert alert-warning" role="alert">
        <strong>Status:</strong> {{ article.status|title }}
        {% if article.status == 'draft' %}
            - This article is still being written
        {% elif article.status == 'review' %}
            - This article is under review
        {% elif article.status == 'hidden' %}
            - This article is temporarily hidden
        {% elif article.status == 'archived' %}
            - This article has been archived
        {% endif %}
    </div>
{% endif %}

{% if article.featured %}
    <div class="alert alert-success" role="alert">
        ‚≠ê <strong>Featured Article</strong>
        {% if article.featured_until %}
            (featured until {{ article.featured_until|strftime('%b %d, %Y') }})
        {% endif %}
    </div>
{% endif %}

<!-- Short description -->
{% if article.summary %}
    <div class="alert alert-info" role="alert">
        <em>{{ article.summary }}</em>
    </div>
{% endif %}

{% if article.categories %}
<div class="article-categories">
    Categories:
    {% for category in article.categories %}
    <a href="/articles?category={{ category }}" class="category-tag">{{ category }}</a>
    {% endfor %}
</div>
{% endif %}

<!-- Enhanced content display with error handling -->
<div class="article-content">
    {% if article.content %}
        {% set content = article.content %}
        {% if content.startswith('```') or '```html' in content or '```markdown' in content %}
            <!-- Handle raw markdown/code blocks -->
            <div class="content-warning">
                <strong>‚ö†Ô∏è Content Format Issue:</strong> This article contains unprocessed code blocks or markdown.
            </div>
            <div class="raw-content-display">
                <pre><code>{{ content }}</code></pre>
            </div>
            <div class="content-help">
                <strong>For editors:</strong> This content needs to be converted to proper HTML. 
                <a href="/articles/{{ article._id }}/edit?mode=html" class="alert-link">Edit this article</a> to fix the formatting.
            </div>
        {% else %}
            {{ content|safe }}
        {% endif %}
    {% else %}
        <div class="no-content">
            <p><em>This article has no content yet.</em></p>
            <p>You can help by <a href="/articles/{{ article._id }}/edit?mode=html">adding content</a> to this article.</p>
        </div>
    {% endif %}
</div>

{% if article.tags %}
<div class="article-tags">
    Tags:
    {% for tag in article.tags %}
    <a href="/articles?tag={{ tag }}" class="tag">{{ tag }}</a>
    {% endfor %}
</div>
{% endif %}

<!-- Enhanced article footer with better button styling -->
<div class="article-footer">
    <div class="article-actions">
        <button id="propose-edit-button" class="action-button">üìù Propose Edit</button>
        <button id="edit-button" class="action-button auth-required">‚úèÔ∏è Edit Article</button>
        <button id="reward-button" class="action-button auth-required">üèÜ Reward Author</button>
        <button id="share-button" class="action-button">üì§ Share</button>
        <button id="manage-button" class="action-button manage-button admin-required">‚öôÔ∏è Manage Article</button>
        <a href="/articles/{{ article._id }}?mode=wiki" class="action-button">üìù Wiki Mode</a>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- All modals from the working version with enhanced styling -->
<!-- Reward Modal -->
<div id="reward-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>üèÜ Reward Contributor</h2>
        <p>Show appreciation for this content by rewarding the contributor.</p>
        <form id="reward-form">
            <input type="hidden" id="article-id" value="{{ article._id }}">
            <div class="form-group">
                <label for="reward-type">Reward Type:</label>
                <select id="reward-type" name="rewardType">
                    <option value="helpful">Helpful</option>
                    <option value="insightful">Insightful</option>
                    <option value="comprehensive">Comprehensive</option>
                </select>
            </div>
            <div class="form-group">
                <label for="points">Points:</label>
                <input type="number" id="points" name="points" min="1" max="10" value="5">
            </div>
            <button type="submit" class="action-button">Give Reward</button>
        </form>
    </div>
</div>

<!-- Share Modal -->
<div id="share-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>üì§ Share Article</h2>
        <p>Share this article with others:</p>
        <div class="form-group">
            <label for="share-url">Article URL:</label>
            <input type="text" id="share-url" value="{{ request.url }}" readonly>
            <button id="copy-url" class="action-button" style="margin-top: 10px;">üìã Copy URL</button>
        </div>
    </div>
</div>

<!-- Enhanced Delete Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>üóëÔ∏è Request Article Deletion</h2>
        <p>Please review the <a href="/help/deletion-policy" target="_blank">deletion policy</a> before proceeding.</p>
        <form id="deletionForm">
            <div class="form-group">
                <label for="deleteReason">Reason for deletion:</label>
                <textarea id="deleteReason" name="reason" required rows="4"
                    placeholder="Cite specific deletion criteria from the policy (e.g., Policy Violation - Spam content, Quality Issue - No meaningful content, etc.)..."></textarea>
            </div>
            {% if current_user and current_user.role in ['admin', 'editor'] %}
            <div class="form-group">
                <label>
                    <input type="checkbox" id="permanentDelete">
                    Permanent deletion (admin only)
                </label>
            </div>
            {% endif %}
            <button type="button" class="action-button" onclick="requestDeletion('{{ article._id }}')">Submit Request</button>
            <button type="button" class="action-button" style="background-color: #6c757d;" onclick="document.getElementById('deleteModal').style.display='none'">Cancel</button>
        </form>
    </div>
</div>

<!-- Article Management Modal -->
<div id="article-management-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>‚öôÔ∏è Article Management</h2>
        
        <div class="status-section">
            <h3>Change Article Status</h3>
            <p>Current status: <span class="article-status">{{ article.status or "published" }}</span></p>
            
            <div class="status-buttons">
                <button id="publish-article" class="status-button {% if article.status == 'published' %}active{% endif %}" data-status="published">Published</button>
                <button id="hide-article" class="status-button {% if article.status == 'hidden' %}active{% endif %}" data-status="hidden">Hidden</button>
                <button id="archive-article" class="status-button {% if article.status == 'archived' %}active{% endif %}" data-status="archived">Archived</button>
                <button id="draft-article" class="status-button {% if article.status == 'draft' %}active{% endif %}" data-status="draft">Draft</button>
            </div>
            
            <div class="status-descriptions">
                <p><strong>Published:</strong> Visible to all users</p>
                <p><strong>Hidden:</strong> Temporarily hidden from users, but not archived</p>
                <p><strong>Archived:</strong> Removed from listings but still accessible by direct URL</p>
                <p><strong>Draft:</strong> Only visible to editors and admins</p>
            </div>
        </div>
        
        <hr>
        
        <div class="danger-section">
            <h3>Danger Zone</h3>
            <p>These actions cannot be undone.</p>
            
            <button id="delete-article" class="danger-button">Permanently Delete Article</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-confirmation-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>‚ö†Ô∏è Confirm Permanent Deletion</h2>
        
        <div class="confirmation-content">
            <p>You are about to <strong>permanently delete</strong> this article:</p>
            <p style="font-weight: bold; font-size: 1.1em; color: #dc3545;">{{ article.title }}</p>
            
            <div class="warning-box">
                <p>‚ö†Ô∏è This action cannot be undone. All revisions, proposals, and rewards associated with this article will also be deleted.</p>
            </div>
            
            <div class="form-group">
                <label for="delete-confirmation">Type "DELETE" to confirm:</label>
                <input type="text" id="delete-confirmation" placeholder="DELETE">
            </div>
            
            <div class="form-actions">
                <button id="confirm-delete" class="danger-button" disabled>Permanently Delete</button>
                <button id="cancel-delete" class="action-button" style="background-color: #6c757d;">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Enhanced JavaScript combining both versions with improvements
document.addEventListener('DOMContentLoaded', function() {
    // Check if user is logged in
    const token = localStorage.getItem('token');
    const authElements = document.querySelectorAll('.auth-required');
    const adminElements = document.querySelectorAll('.admin-required');
    
    if (token) {
        // User is logged in, show auth-required elements
        authElements.forEach(element => {
            element.style.display = 'inline-block';
        });
        
        // Check if user is admin/editor for admin-required elements
        fetch('/api/auth/me', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to get user info');
            }
            return response.json();
        })
        .then(user => {
            // Only show admin-required elements for admins/editors
            if (user.role === 'admin' || user.role === 'editor') {
                adminElements.forEach(element => {
                    element.style.display = 'inline-block';
                });
            }
        })
        .catch(error => {
            console.error('Error checking user role:', error);
        });
    } else {
        // User is not logged in, hide auth-required and admin-required elements
        authElements.forEach(element => {
            element.style.display = 'none';
        });
        
        adminElements.forEach(element => {
            element.style.display = 'none';
        });
    }
    
    // Enhanced voting functionality
    const upvoteButton = document.getElementById('upvote-button');
    const downvoteButton = document.getElementById('downvote-button');
    const voteCount = document.getElementById('vote-count');
    
    // Function to get current vote status
    async function getVoteStatus() {
        try {
            const response = await fetch(`/api/articles/{{ article._id }}/votes`, {
                headers: token ? { 'Authorization': `Bearer ${token}` } : {}
            });
            
            if (!response.ok) {
                throw new Error('Failed to get vote status');
            }
            
            const data = await response.json();
            
            // Update vote count
            voteCount.textContent = data.upvotes - data.downvotes;
            
            // Set active state based on user's vote
            if (data.userVote === 'upvote') {
                upvoteButton.classList.add('active');
                downvoteButton.classList.remove('active');
            } else if (data.userVote === 'downvote') {
                downvoteButton.classList.add('active');
                upvoteButton.classList.remove('active');
            } else {
                upvoteButton.classList.remove('active');
                downvoteButton.classList.remove('active');
            }
        } catch (error) {
            console.error('Error getting vote status:', error);
        }
    }
    
    // Get initial vote status
    getVoteStatus();
    
    // Handle upvote button
    upvoteButton.addEventListener('click', async function() {
        if (!token) {
            // Show login modal if user is not logged in
            const loginModal = document.getElementById('login-modal');
            if (loginModal) loginModal.style.display = 'block';
            return;
        }
        
        try {
            const response = await fetch(`/api/articles/{{ article._id }}/vote`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ vote_type: 'upvote' })
            });
            
            if (!response.ok) {
                throw new Error('Failed to upvote article');
            }
            
            const data = await response.json();
            
            // Update the vote count
            voteCount.textContent = data.upvotes - data.downvotes;
            
            // Update button states
            if (upvoteButton.classList.contains('active')) {
                upvoteButton.classList.remove('active');
            } else {
                upvoteButton.classList.add('active');
                downvoteButton.classList.remove('active');
            }
        } catch (error) {
            console.error('Error upvoting article:', error);
        }
    });
    
    // Handle downvote button
    downvoteButton.addEventListener('click', async function() {
        if (!token) {
            const loginModal = document.getElementById('login-modal');
            if (loginModal) loginModal.style.display = 'block';
            return;
        }
        
        try {
            const response = await fetch(`/api/articles/{{ article._id }}/vote`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ vote_type: 'downvote' })
            });
            
            if (!response.ok) {
                throw new Error('Failed to downvote article');
            }
            
            const data = await response.json();
            
            // Update the vote count
            voteCount.textContent = data.upvotes - data.downvotes;
            
            // Update button states
            if (downvoteButton.classList.contains('active')) {
                downvoteButton.classList.remove('active');
            } else {
                downvoteButton.classList.add('active');
                upvoteButton.classList.remove('active');
            }
        } catch (error) {
            console.error('Error downvoting article:', error);
        }
    });
    
    // Set up all button event listeners
    setupButtonListeners();
    
    // Set up modal functionality
    setupModals();
    
    // Set up article management
    setupArticleManagement();
    
    // Track page view
    if (typeof gtag !== 'undefined') {
        gtag('event', 'page_view', {
            page_title: '{{ article.title }}',
            page_location: window.location.href
        });
    }
});

// Enhanced delete modal function
function showDeleteModal(articleId) {
    const modal = document.getElementById('deleteModal');
    if (modal) {
        modal.style.display = 'block';
    }
}

function requestDeletion(articleId) {
    const reason = document.getElementById('deleteReason').value.trim();
    const permanentCheckbox = document.getElementById('permanentDelete');
    const permanent = permanentCheckbox ? permanentCheckbox.checked : false;
    
    if (!reason) {
        alert('Please provide a reason for deletion.');
        return;
    }
    
    const token = localStorage.getItem('token');
    if (!token) {
        alert('You must be logged in to request deletion.');
        return;
    }
    
    // Send deletion request
    fetch(`/api/articles/${articleId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
            reason: reason,
            permanent: permanent
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.deletedImmediately) {
            alert(data.message);
            window.location.href = '/';
        } else {
            alert(data.message);
            if (data.discussionUrl) {
                window.location.href = data.discussionUrl;
            }
        }
        document.getElementById('deleteModal').style.display = 'none';
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to submit deletion request. Please try again.');
    });
}

// Function to set up button listeners
function setupButtonListeners() {
    const proposeEditButton = document.getElementById('propose-edit-button');
    if (proposeEditButton) {
        proposeEditButton.addEventListener('click', function() {
            window.location.href = '/articles/{{ article._id }}/propose';
        });
    }
    
    const editButton = document.getElementById('edit-button');
    if (editButton) {
        editButton.addEventListener('click', function() {
            const token = localStorage.getItem('token');
            if (!token) {
                const loginModal = document.getElementById('login-modal');
                if (loginModal) loginModal.style.display = 'block';
                return;
            }
            window.location.href = '/edit-article/{{ article._id }}';
        });
    }
    
    const rewardButton = document.getElementById('reward-button');
    if (rewardButton) {
        rewardButton.addEventListener('click', function() {
            const token = localStorage.getItem('token');
            if (!token) {
                const loginModal = document.getElementById('login-modal');
                if (loginModal) loginModal.style.display = 'block';
                return;
            }
            const rewardModal = document.getElementById('reward-modal');
            if (rewardModal) rewardModal.style.display = 'block';
        });
    }
    
    const shareButton = document.getElementById('share-button');
    if (shareButton) {
        shareButton.addEventListener('click', function() {
            const shareModal = document.getElementById('share-modal');
            if (shareModal) shareModal.style.display = 'block';
        });
    }
    
    const copyUrlButton = document.getElementById('copy-url');
    if (copyUrlButton) {
        copyUrlButton.addEventListener('click', function() {
            const shareUrl = document.getElementById('share-url');
            shareUrl.select();
            navigator.clipboard.writeText(shareUrl.value).then(function() {
                alert('URL copied to clipboard!');
            });
        });
    }
}

// Function to set up modal functionality
function setupModals() {
    const closeButtons = document.querySelectorAll('.close');
    closeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const modal = this.closest('.modal');
            if (modal) modal.style.display = 'none';
        });
    });
    
    window.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    });
    
    // Set up reward form submission
    const rewardForm = document.getElementById('reward-form');
    if (rewardForm) {
        rewardForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const articleId = document.getElementById('article-id').value;
            const rewardType = document.getElementById('reward-type').value;
            const points = parseInt(document.getElementById('points').value);
            
            const token = localStorage.getItem('token');
            if (!token) {
                alert('You must be logged in to give rewards.');
                return;
            }
            
            const rewardData = {
                rewardType: rewardType,
                points: points
            };
            
            fetch(`/api/rewards/articles/${articleId}/rewards`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(rewardData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.detail || 'Failed to give reward');
                    });
                }
                return response.json();
            })
            .then(data => {
                alert('Reward given successfully!');
                const rewardModal = document.getElementById('reward-modal');
                if (rewardModal) rewardModal.style.display = 'none';
            })
            .catch(error => {
                console.error('Error giving reward:', error);
                alert(error.message || 'Failed to give reward. Please try again.');
            });
        });
    }
}

// Function to set up article management
function setupArticleManagement() {
    const manageButton = document.getElementById('manage-button');
    const articleManagementModal = document.getElementById('article-management-modal');
    const deleteConfirmationModal = document.getElementById('delete-confirmation-modal');
    
    if (manageButton) {
        manageButton.addEventListener('click', function() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('You must be logged in as an administrator to manage articles');
                const loginModal = document.getElementById('login-modal');
                if (loginModal) loginModal.style.display = 'block';
                return;
            }
            
            if (articleManagementModal) {
                articleManagementModal.style.display = 'block';
            }
        });
    }
    
    // Set up status buttons
    const statusButtons = document.querySelectorAll('.status-button');
    statusButtons.forEach(button => {
        button.addEventListener('click', function() {
            const newStatus = this.dataset.status;
            
            if (this.classList.contains('active')) {
                return;
            }
            
            if (!confirm(`Are you sure you want to change the article status to "${newStatus}"?`)) {
                return;
            }
            
            this.disabled = true;
            const originalText = this.textContent;
            this.textContent = `Updating...`;
            
            updateArticleStatus(newStatus)
                .then(success => {
                    if (success) {
                        statusButtons.forEach(btn => btn.classList.remove('active'));
                        this.classList.add('active');
                        
                        const statusDisplay = document.querySelector('.article-status');
                        if (statusDisplay) {
                            statusDisplay.textContent = newStatus;
                        }
                        
                        alert(`Article status updated to "${newStatus}"`);
                        
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                })
                .finally(() => {
                    this.disabled = false;
                    this.textContent = originalText;
                });
        });
    });
    
    // Set up delete functionality
    const deleteArticleButton = document.getElementById('delete-article');
    const confirmDeleteButton = document.getElementById('confirm-delete');
    const cancelDeleteButton = document.getElementById('cancel-delete');
    const deleteConfirmationInput = document.getElementById('delete-confirmation');
    
    if (deleteArticleButton) {
        deleteArticleButton.addEventListener('click', function() {
            if (articleManagementModal) {
                articleManagementModal.style.display = 'none';
            }
            if (deleteConfirmationModal) {
                deleteConfirmationModal.style.display = 'block';
            }
        });
    }
    
    if (deleteConfirmationInput) {
        deleteConfirmationInput.addEventListener('input', function() {
            if (this.value === 'DELETE') {
                confirmDeleteButton.disabled = false;
            } else {
                confirmDeleteButton.disabled = true;
            }
        });
    }
    
    if (confirmDeleteButton) {
        confirmDeleteButton.addEventListener('click', function() {
            if (deleteConfirmationInput.value !== 'DELETE') {
                return;
            }
            
            this.disabled = true;
            this.textContent = 'Deleting...';
            
            // Use the requestDeletion function instead of deleteArticle
            // This bypasses the broken backend logic
            const token = localStorage.getItem('token');
            if (!token) {
                alert('You must be logged in to perform this action');
                return;
            }
            
            fetch(`/api/articles/{{ article._id }}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    reason: 'Permanent deletion requested by admin',
                    permanent: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.deletedImmediately) {
                    alert(data.message);
                    window.location.href = '/';
                } else {
                    alert(data.message);
                    if (data.discussionUrl) {
                        window.location.href = data.discussionUrl;
                    }
                }
                document.getElementById('delete-confirmation-modal').style.display = 'none';
            })
            .catch(error => {
                console.error('Error:', error);
                this.disabled = false;
                this.textContent = 'Permanently Delete';
                alert('Error deleting article: ' + error.message);
            });
        });
    }
    
    if (cancelDeleteButton) {
        cancelDeleteButton.addEventListener('click', function() {
            if (deleteConfirmationModal) {
                deleteConfirmationModal.style.display = 'none';
            }
            if (articleManagementModal) {
                articleManagementModal.style.display = 'block';
            }
            if (deleteConfirmationInput) {
                deleteConfirmationInput.value = '';
            }
            if (confirmDeleteButton) {
                confirmDeleteButton.disabled = true;
            }
        });
    }
}

// Helper functions
async function updateArticleStatus(newStatus) {
    try {
        const token = localStorage.getItem('token');
        if (!token) {
            throw new Error('You must be logged in to perform this action');
        }
        
        const response = await fetch(`/api/articles/{{ article._id }}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                status: newStatus
            })
        });
        
        if (!response.ok) {
            const data = await response.json();
            throw new Error(data.detail || 'Failed to update article status');
        }
        
        return true;
    } catch (error) {
        console.error('Error updating article status:', error);
        alert('Error updating article status: ' + error.message);
        return false;
    }
}

async function deleteArticle() {
    try {
        const token = localStorage.getItem('token');
        if (!token) {
            throw new Error('You must be logged in to perform this action');
        }
        
        const response = await fetch(`/api/articles/{{ article._id }}?permanent=true`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            const data = await response.json();
            throw new Error(data.detail || 'Failed to delete article');
        }
        
        return true;
    } catch (error) {
        console.error('Error deleting article:', error);
        throw error;
    }
}
</script>
{% endblock %}
