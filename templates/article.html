<!-- File: templates/article.html -->
{% extends "base.html" %}

{% block title %}{{ article.title }} - Kryptopedia{% endblock %}

{% block sidebar_extra %}
<h3>Article Tools</h3>
<ul>
    <li><a href="/articles/{{ article._id }}/edit" id="edit-article" class="auth-required">Edit Article</a></li>
    <li><a href="/articles/{{ article._id }}/propose" id="propose-edit">Propose Edit</a></li>
    <li><a href="/articles/{{ article._id }}/history" id="article-history">History</a></li>
    <li><a href="/articles/{{ article._id }}/proposals" id="article-proposals">View Proposals</a></li>
    <li><a href="/articles/{{ article._id }}/reward" id="reward-article" class="auth-required">Reward Contributor</a></li>
</ul>
{% endblock %}

{% block content %}
<div class="article-header">
    <h1>{{ article.title }}</h1>
    <div class="article-meta">
        <span>Views: {{ article.views }}</span>
        <span>Last updated: {{ article.lastUpdatedAt|strftime('%Y-%m-%d') or article.createdAt|strftime('%Y-%m-%d') }}</span>
    </div>
</div>

{% if article.categories %}
<div class="article-categories">
    Categories:
    {% for category in article.categories %}
    <a href="/articles?category={{ category }}" class="category-tag">{{ category }}</a>
    {% endfor %}
</div>
{% endif %}

<div class="article-content">
    {{ article.content|safe }}
</div>

{% if article.tags %}
<div class="article-tags">
    Tags:
    {% for tag in article.tags %}
    <a href="/articles?tag={{ tag }}" class="tag">{{ tag }}</a>
    {% endfor %}
</div>
{% endif %}

<div class="article-footer">
    <div class="article-actions">
        <button id="propose-edit-button" class="action-button">Propose Edit</button>
        <button id="edit-button" class="action-button auth-required">Edit Article</button>
        <button id="reward-button" class="action-button auth-required">Reward Author</button>
        <button id="share-button" class="action-button">Share</button>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Reward Modal -->
<div id="reward-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Reward Contributor</h2>
        <p>Show appreciation for this content by rewarding the contributor.</p>
        <form id="reward-form">
            <input type="hidden" id="article-id" value="{{ article._id }}">
            <div class="form-group">
                <label for="reward-type">Reward Type:</label>
                <select id="reward-type" name="rewardType">
                    <option value="helpful">Helpful</option>
                    <option value="insightful">Insightful</option>
                    <option value="comprehensive">Comprehensive</option>
                </select>
            </div>
            <div class="form-group">
                <label for="points">Points:</label>
                <input type="number" id="points" name="points" min="1" max="10" value="5">
            </div>
            <button type="submit">Give Reward</button>
        </form>
    </div>
</div>

<!-- Share Modal -->
<div id="share-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Share Article</h2>
        <p>Share this article with others:</p>
        <div class="form-group">
            <label for="share-url">Article URL:</label>
            <input type="text" id="share-url" value="{{ request.url }}" readonly>
            <button id="copy-url">Copy</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if user is logged in
    const token = localStorage.getItem('token');
    const authElements = document.querySelectorAll('.auth-required');
    
    if (token) {
        // User is logged in, show auth-required elements
        authElements.forEach(element => {
            element.style.display = 'inline-block';
        });
    } else {
        // User is not logged in, hide auth-required elements
        authElements.forEach(element => {
            element.style.display = 'none';
        });
    }
    
    // Set up propose edit button
    const proposeEditButton = document.getElementById('propose-edit-button');
    if (proposeEditButton) {
        proposeEditButton.addEventListener('click', function() {
            window.location.href = '/articles/{{ article._id }}/propose';
        });
    }
    
    // Set up edit button
    const editButton = document.getElementById('edit-button');
    if (editButton) {
        editButton.addEventListener('click', function() {
            // Check if user is logged in
            if (!token) {
                // Not logged in, show login modal
                const loginModal = document.getElementById('login-modal');
                if (loginModal) loginModal.style.display = 'block';
                return;
            }
            
            window.location.href = '/articles/{{ article._id }}/edit';
        });
    }
    
    // Set up reward button
    const rewardButton = document.getElementById('reward-button');
    if (rewardButton) {
        rewardButton.addEventListener('click', function() {
            // Check if user is logged in
            if (!token) {
                // Not logged in, show login modal
                const loginModal = document.getElementById('login-modal');
                if (loginModal) loginModal.style.display = 'block';
                return;
            }
            
            // Show reward modal
            const rewardModal = document.getElementById('reward-modal');
            if (rewardModal) rewardModal.style.display = 'block';
        });
    }
    
    // Set up reward form submission
    const rewardForm = document.getElementById('reward-form');
    if (rewardForm) {
        rewardForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get form values
            const articleId = document.getElementById('article-id').value;
            const rewardType = document.getElementById('reward-type').value;
            const points = parseInt(document.getElementById('points').value);
            
            // Get token
            const token = localStorage.getItem('token');
            if (!token) {
                alert('You must be logged in to give rewards.');
                return;
            }
            
            // Create reward data
            const rewardData = {
                rewardType: rewardType,
                points: points
            };
            
            // Submit reward
            fetch(`/api/rewards/articles/${articleId}/rewards`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(rewardData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.detail || 'Failed to give reward');
                    });
                }
                return response.json();
            })
            .then(data => {
                alert('Reward given successfully!');
                const rewardModal = document.getElementById('reward-modal');
                if (rewardModal) rewardModal.style.display = 'none';
            })
            .catch(error => {
                console.error('Error giving reward:', error);
                alert(error.message || 'Failed to give reward. Please try again.');
            });
        });
    }
    
    // Set up share button
    const shareButton = document.getElementById('share-button');
    if (shareButton) {
        shareButton.addEventListener('click', function() {
            const shareModal = document.getElementById('share-modal');
            if (shareModal) shareModal.style.display = 'block';
        });
    }
    
    // Set up copy URL button
    const copyUrlButton = document.getElementById('copy-url');
    if (copyUrlButton) {
        copyUrlButton.addEventListener('click', function() {
            const shareUrl = document.getElementById('share-url');
            shareUrl.select();
            document.execCommand('copy');
            alert('URL copied to clipboard!');
        });
    }
    
    // Modal closing
    const closeButtons = document.querySelectorAll('.close');
    closeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const modal = this.closest('.modal');
            if (modal) modal.style.display = 'none';
        });
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    });
});
</script>
{% endblock %}
