<!-- File: templates/article.html (Sidebar Section Update) -->
<!-- Add this to your article template sidebar -->

<div class="article-sidebar">
    <div class="article-actions">
        <h3>Article Actions</h3>
        <ul class="list-unstyled">
            {% if user_info.type == 'authenticated' %}
                <li><a href="/articles/{{ article._id }}/edit" class="btn btn-outline-primary btn-sm">‚úèÔ∏è Edit Article</a></li>
                {% if user_info.user._id == article.createdBy or user_info.user.role in ['admin', 'editor'] %}
                    <li><button onclick="showDeleteModal('{{ article._id }}')" class="btn btn-outline-danger btn-sm mt-2">
                        üóëÔ∏è Request Deletion
                    </button></li>
                {% endif %}
            {% endif %}
            <li><a href="/articles/{{ article._id }}/history" class="btn btn-outline-secondary btn-sm mt-2">üìú View History</a></li>
            <li><a href="/help/deletion-policy" class="btn btn-outline-info btn-sm mt-2">üìã Deletion Policy</a></li>
        </ul>
    </div>

    <div class="article-info mt-4">
        <h3>Article Information</h3>
        <dl>
            <dt>Created:</dt>
            <dd>{{ article.createdAt|strftime('%Y-%m-%d') }}</dd>
            
            <dt>Last Updated:</dt>
            <dd>{{ article.updatedAt|strftime('%Y-%m-%d') }}</dd>
            
            {% if article.categories %}
            <dt>Categories:</dt>
            <dd>
                {% for category in article.categories %}
                    <span class="badge bg-secondary me-1">{{ category }}</span>
                {% endfor %}
            </dd>
            {% endif %}
            
            {% if article.tags %}
            <dt>Tags:</dt>
            <dd>
                {% for tag in article.tags %}
                    <span class="badge bg-light text-dark me-1">{{ tag }}</span>
                {% endfor %}
            </dd>
            {% endif %}
        </dl>
    </div>

    {% if article.status != 'published' %}
    <div class="article-status mt-4">
        <h3>Status</h3>
        <span class="badge bg-warning">{{ article.status|title }}</span>
        {% if user_info.type == 'authenticated' and user_info.user.role in ['admin', 'editor'] %}
            <p class="small text-muted mt-2">This article is not publicly visible.</p>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Enhanced Delete Modal Script -->
<script>
function showDeleteModal(articleId) {
    const modal = `
        <div class="modal fade" id="deleteModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Request Article Deletion</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Please review the <a href="/help/deletion-policy" target="_blank">deletion policy</a> before proceeding.</p>
                        <form id="deletionForm">
                            <div class="mb-3">
                                <label for="deleteReason" class="form-label">Reason for deletion:</label>
                                <textarea class="form-control" id="deleteReason" name="reason" required 
                                    placeholder="Cite specific deletion criteria from the policy (e.g., Policy Violation - Spam content, Quality Issue - No meaningful content, etc.)..."></textarea>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="permanentDelete">
                                <label class="form-check-label" for="permanentDelete">
                                    Permanent deletion (admin only)
                                </label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" onclick="requestDeletion('${articleId}')">Submit Request</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('deleteModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modal);
    const modalInstance = new bootstrap.Modal(document.getElementById('deleteModal'));
    modalInstance.show();
}

function requestDeletion(articleId) {
    const reason = document.getElementById('deleteReason').value.trim();
    const permanent = document.getElementById('permanentDelete').checked;
    
    if (!reason) {
        alert('Please provide a reason for deletion.');
        return;
    }
    
    const token = localStorage.getItem('token');
    if (!token) {
        alert('You must be logged in to request deletion.');
        return;
    }
    
    // Send deletion request
    fetch(`/api/articles/${articleId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
            reason: reason,
            permanent: permanent
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.deletedImmediately) {
            alert(data.message);
            window.location.href = '/';
        } else {
            alert(data.message);
            if (data.discussionUrl) {
                window.location.href = data.discussionUrl;
            }
        }
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
        modal.hide();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to submit deletion request. Please try again.');
    });
}
</script>
